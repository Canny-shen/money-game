<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç†è²¡å°å¯Œç¿ï¼ˆå‹•ç‰©ç‰ˆï¼‰â€” éŠ€è¡Œ/è²¸æ¬¾/è‚¡åˆ©/åœç‰Œ/æŠ•è³‡äº‹ä»¶</title>
<style>
  :root{
    --primary:#5d9cec; --panel:#ffffff; --bg:#f0f8ff; --ink:#0f172a;
    --accent:#8fb3ff; --good:#2e7d32; --bad:#c62828;
  }
  *{box-sizing:border-box}
  body{font-family:"Noto Sans TC",Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0;padding:12px}
  .layout{display:flex; gap:16px; align-items:flex-start; justify-content:center; max-width:1400px; margin:0 auto;}
  .leftCol{flex:0 0 560px; display:flex; flex-direction:column; gap:12px}
  .rightCol{flex:0 1 auto}
  .panel{background:var(--panel); border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.12); padding:12px;}
  h1{margin:0 0 12px; text-align:center}
  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  input,select{padding:6px;border-radius:8px;border:1px solid #cbd5e1}
  input[type=number]{width:120px}
  button{padding:8px 12px;border:0;border-radius:10px;background:var(--primary);color:#fff;font-size:14px;cursor:pointer}
  button.secondary{background:#e2e8f0;color:#111}

  /* é ­åƒå¡ */
  #avatars{display:flex;flex-wrap:wrap;gap:10px}
  .avatar{position:relative;width:150px;border:2px solid #ccc;border-radius:12px;background:#fff8dc;cursor:pointer;padding:6px;display:flex;flex-direction:column;align-items:center;gap:6px;transition:transform .15s,border-color .2s}
  .avatar:hover{transform:translateY(-2px);border-color:var(--primary)}
  .avatar .imgWrap{position:relative;width:100%}
  .avatar img{width:100%;height:auto;object-fit:contain;border-radius:10px}
  .avatar span{font-size:14px;font-weight:700}
  .avatar .pickedName{position:absolute;left:6px;right:6px;bottom:6px;background:rgba(0,0,0,.6);color:#fff;font-weight:700;font-size:14px;padding:4px 6px;border-radius:8px;text-align:center;display:none}
  .avatar.selected{border-color:var(--primary);box-shadow:0 0 0 3px rgba(93,156,236,.25) inset}
  .avatar.selected .pickedName{display:block}
  .avatar:disabled{opacity:.6;cursor:not-allowed}

  /* è³‡è¨Šåˆ— */
  .stats{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0}
  .chip{background:#fff;border-radius:999px;padding:6px 10px;box-shadow:0 2px 8px rgba(0,0,0,.07);font-size:13px}
  .good{color:var(--good)} .bad{color:var(--bad)}

  /* éª°å­èˆ‡å¡ */
  #dice{font-size:72px;cursor:pointer;user-select:none;margin-top:6px;text-align:center}
  #result{margin-top:6px;font-size:18px;font-weight:700;text-align:center;min-height:1.6em}
  #card{display:none;border:2px solid var(--accent);padding:12px;margin:10px 0 0;border-radius:14px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.12)}
  #card h3{margin:4px 0 6px}
  #card .amount{font-weight:700}

  /* æ£‹ç›¤ */
  .boardWrap{position:sticky; top:8px}
  .boardTitle{margin:0 0 8px}
  .board{display:grid; grid-template-columns:repeat(8, 70px); grid-template-rows:repeat(8, 70px); gap:4px; background:#dbeafe; padding:6px; border-radius:12px;}
  .cell{background:#eaf4ff;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#333}
  .tile{background:#fff;border:2px solid var(--accent);border-radius:10px;padding:3px;width:100%;height:100%;display:flex;flex-direction:column;justify-content:space-between}
  .tile h4{margin:0 2px 2px;font-size:11px;line-height:1.15}
  .pills{display:flex;flex-wrap:wrap;gap:2px;padding:2px 2px 0}
  .pill{display:inline-flex;flex-direction:column;align-items:center;font-size:9px;background:#eef3ff;border:1px solid #c7d8ff;border-radius:6px;padding:1px 3px}
  .pill .nm{font-size:9px;line-height:1;margin-top:1px;color:#111}
  #tileInfo{margin-top:6px;font-size:14px}

  /* è¡¨æ ¼ */
  #holdings{width:100%; overflow:auto; border-top:1px dashed #cbd5e1; margin-top:8px; padding-top:8px}
  #holdings table{width:100%; border-collapse:collapse; font-size:12px}
  #holdings th,#holdings td{border-bottom:1px solid #eef2f7; padding:6px 4px; text-align:right}
  #holdings th:first-child,#holdings td:first-child{text-align:left}
  .pl{color:var(--good)} .mn{color:var(--bad)}

  details{margin-top:8px}
  summary{cursor:pointer}

  @media (max-width: 1100px){
    .layout{flex-direction:column}
    .leftCol,.rightCol{width:100%}
    .board{grid-template-columns:repeat(8, 52px); grid-template-rows:repeat(8, 52px)}
  }
</style>
</head>
<body>
  <h1>ğŸ² ç†è²¡å°å¯Œç¿ï¼ˆå‹•ç‰©ç‰ˆï¼‰</h1>

  <div class="layout">
    <div class="leftCol">
      <div class="panel" id="setup">
        <h3>ç©å®¶èˆ‡è¦å‰‡</h3>
        <div class="row">
          <input id="nameInput" placeholder="è«‹è¼¸å…¥ç©å®¶åç¨±"/>
          <div>åˆå§‹é‡‘é¡ï¼š<input id="startMoney" type="number" min="0" step="100" value="3000" style="width:120px"></div>
          <div>å›åˆä¸Šé™ï¼š<input type="number" id="roundLimit" min="1" max="100" value="100" style="width:90px"></div><!-- ğŸ†• é è¨­ 100 -->
          <div>å‹åˆ©æ·¨å€¼ï¼ˆ0=é—œé–‰ï¼‰ï¼š<input type="number" id="winTarget" min="0" step="100" value="0" style="width:120px"></div><!-- ğŸ†• é è¨­ 0 é—œé–‰ -->
        </div>
        <p style="margin:6px 0">é»ä¸‹æ–¹å‹•ç‰©åŠ å…¥ï¼ˆæœ€å¤š 8 äººï¼‰ï¼š</p>
        <div id="avatars"></div>
        <div class="row" style="margin-top:8px">
          <button id="startGame">é–‹å§‹éŠæˆ²</button>
          <button id="quickNew" class="secondary">æ–°å±€ï¼ˆä¿ç•™ç©å®¶ï¼Œä¸è®Šæ›´æ£‹ç›¤ï¼‰</button>
          <button id="reseedNew" class="secondary">æ–°å±€ï¼‹é‡æŠ½æ£‹ç›¤</button>
        </div>
      </div>

      <div class="panel" id="game" style="display:none">
        <h3>ç›®å‰ç©å®¶ï¼š <span id="currentPlayerName"></span></h3>
        <div class="row"><span>å›åˆï¼š<span id="roundNow">1</span>/<span id="roundMax">100</span></span></div>
        <div class="stats">
          <div class="chip good">ç¸½æ”¶å…¥ï¼š<span id="income">0</span></div>
          <div class="chip bad">ç¸½æ”¯å‡ºï¼š<span id="expense">0</span></div>
          <div class="chip">ç¾é‡‘é¤˜é¡ï¼š<strong id="balance">0</strong></div>
          <div class="chip">å­˜æ¬¾ï¼š<strong id="chipDeposit">0</strong></div><!-- ğŸ†• -->
          <div class="chip bad">è²¸æ¬¾ï¼š<strong id="chipLoan">0</strong></div><!-- ğŸ†• -->
          <div class="chip">è³‡ç”¢æ·¨å€¼ï¼š<strong id="networth">0</strong></div>
          <div class="chip">è‚¡ç¥¨ï¼š<strong id="stockSummary">â€”</strong></div>
        </div>

        <div id="dice" title="é»æˆ‘æ“²éª°">ğŸ²</div>
        <div id="result"></div>

        <div id="card">
          <div class="row">
            <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
              <img id="cardAvatar" alt="è§’è‰²" style="width:72px;height:72px;border-radius:12px;object-fit:cover"/>
              <div id="characterName" style="font-weight:600"></div>
            </div>
            <div style="flex:1;min-width:280px">
              <h3 id="cardTitle">äº‹ä»¶å¡</h3>
              <p id="cardText">å…§å®¹æœƒåœ¨é€™è£¡å‡ºç¾</p>
              <p class="amount" id="cardAmount"></p>

              <!-- è‚¡ç¥¨æ“ä½œåˆ— -->
              <div id="stockActions" class="row" style="display:none">
                <div>ğŸ“ˆ æ¨™çš„ï¼š
                  <select id="stockSelect"></select>
                </div>
                <div>å¸‚åƒ¹ï¼š<b id="stockPrice"></b></div>
                <div>æ•¸é‡ï¼š<input id="stockQty" type="number" min="1" value="1" style="width:80px"></div>
                <button id="btnBuy">è²·å…¥</button>
                <button id="btnSell" class="secondary">è³£å‡º</button>
              </div>

              <!-- ğŸ†• éŠ€è¡Œæ“ä½œåˆ—ï¼ˆæ¯åœˆé–‹å•Ÿï¼‰ -->
              <div id="bankActions" class="row" style="display:none; align-items:flex-end">
                <div>é‡‘é¡ï¼š<input id="bankAmt" type="number" min="0" value="0" style="width:110px"></div>
                <button id="btnDeposit">å­˜å…¥</button>
                <button id="btnWithdraw" class="secondary">æé ˜</button>
                <div class="chip">å­˜æ¬¾é¤˜é¡ï¼š$ <span id="bankBal">0</span></div>
                <button id="btnContinue" class="secondary" style="margin-left:auto">ç¹¼çºŒå‰é€² â–¶</button>
              </div>

              <div class="row" style="margin-top:6px">
                <button id="buyBtn" class="secondary" style="display:none">è³¼è²·/å‡ç´šåœ°ç”¢</button>
                <button id="okBtn">çŸ¥é“äº†</button>
                <button id="nextBtn" class="secondary">ä¸‹ä¸€ä½</button>
              </div>
            </div>
          </div>
        </div>

        <details>
          <summary>ğŸ“’ æ”¶æ”¯æ˜ç´°ï¼ˆç›®å‰ç©å®¶ï¼‰</summary>
          <ul id="ledger" style="text-align:left;max-height:240px;overflow:auto;margin:8px 0 0"></ul>
        </details>

        <details>
          <summary>ğŸ¦ éŠ€è¡Œï¼ˆå­˜æ¬¾/è²¸æ¬¾æ˜ç´°ï¼‰</summary><!-- ğŸ†• -->
          <div id="bankPanel" style="font-size:13px"></div>
        </details>

        <details>
          <summary>ğŸ“Š æ’è¡Œï¼ˆæ·¨å€¼ï¼šç¾é‡‘+å­˜æ¬¾+åœ°ç”¢+è‚¡ç¥¨âˆ’è²¸æ¬¾ï¼‰</summary>
          <ol id="leaderboard" style="text-align:left;margin:8px 0 0"></ol>
        </details>
      </div>
    </div>

    <div class="rightCol">
      <div class="panel boardWrap">
        <h3 class="boardTitle">8Ã—8 èºæ—‹æ£‹ç›¤ï¼ˆå¤–æ¡†â†’å‘å…§ï¼‰</h3>
        <div id="board" class="board" aria-live="polite"></div>
        <div id="tileInfo">ä½ç½®ï¼šâ€”</div>
      </div>
    </div>
  </div>

  <div id="testOutput" style="display:none;white-space:pre-wrap;background:#fff;border:1px dashed #bbb;padding:8px;max-width:1200px;margin:10px auto"></div>

<script>
addEventListener('DOMContentLoaded', () => {
  // ========= åƒæ•¸ï¼ˆå¯èª¿ï¼‰ =========
  const PERIODS_PER_YEAR = 12;           // ğŸ†• æ¯åœˆè¦–ç‚º 1 æœŸ
  const DEPOSIT_APR = 0.015;             // ğŸ†• å­˜æ¬¾å¹´åˆ©ç‡ 1.5%
  const MORTGAGE_APR = 0.025;            // ğŸ†• åœ°ç”¢è²¸æ¬¾å¹´åˆ©ç‡ 2.5%
  const MARGIN_APR = 0.06;               // ğŸ†• è‚¡ç¥¨èè³‡åˆ©ç‡ 6%
  const PRICE_LIMIT = 0.10;              // ğŸ†• è‡ºç£æ¼²è·Œå¹… 10%
  const NEWS_PROB_PER_TURN = 0.25;       // ğŸ†• æ¯ä½ç©å®¶å›åˆé–‹é ­è§¸ç™¼å¸‚å ´æ–°èæ©Ÿç‡

  // ========= å°å·¥å…· =========
  const $ = id => document.getElementById(id);
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const money = n => Number(Math.round(n)).toLocaleString('zh-TW');
  const randInt=(min,max,rnd=Math.random)=>Math.floor(min + rnd()*(max-min+1));
  const nowStr=()=>new Date().toLocaleString();

  // ğŸ†• æ”¤é‚„è¨ˆç®—ï¼šæœŸä»˜é¡ï¼ˆæœ¬æ¯å¹³å‡ï¼‰
  function amortizedPayment(principal, apr, years){
    const n = Math.max(1, Math.round(years*PERIODS_PER_YEAR));
    const r = apr / PERIODS_PER_YEAR;
    if(r===0) return Math.round(principal/n);
    const f = Math.pow(1+r, n);
    return Math.round(principal * r * f / (f-1));
  }

  // è§’è‰²åœ–ï¼šå…§åµŒ SVGï¼ˆæ²¿ç”¨ï¼‰
  function svgAnimal(emoji, bg){
    const svg = `<?xml version='1.0' encoding='UTF-8'?>
      <svg xmlns='http://www.w3.org/2000/svg' width='400' height='400'>
        <rect width='100%' height='100%' rx='40' ry='40' fill='${bg}'/>
        <circle cx='200' cy='150' r='120' fill='rgba(255,255,255,0.85)' />
        <text x='50%' y='58%' dominant-baseline='middle' text-anchor='middle' font-size='160'>${emoji}</text>
      </svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  }
  const CHARACTERS = [
    { name: 'å°ç†Š',   emoji:'ğŸ»', bg:'#FFD166' },
    { name: 'å°å…”',   emoji:'ğŸ°', bg:'#EF476F' },
    { name: 'å°ç‹—',   emoji:'ğŸ¶', bg:'#06D6A0' },
    { name: 'å°è²“',   emoji:'ğŸ±', bg:'#118AB2' },
    { name: 'å°è±¡',   emoji:'ğŸ˜', bg:'#8ECAE6' },
    { name: 'å°ç‹ç‹¸', emoji:'ğŸ¦Š', bg:'#FFB703' },
    { name: 'å°é³¥',   emoji:'ğŸ¦', bg:'#A3D9A5' },
    { name: 'å°ä¼éµ', emoji:'ğŸ§', bg:'#CBD5E1' }
  ].map(c => ({ ...c, img: svgAnimal(c.emoji, c.bg) }));

  // ========= DOM =========
  const nameInput=$('nameInput');
  const startMoneyInput=$('startMoney');
  const roundLimitInput=$('roundLimit');
  const winTargetInput=$('winTarget');

  const avatarsEl=$('avatars');
  const startBtn=$('startGame');
  const quickNewBtn=$('quickNew');
  const reseedNewBtn=$('reseedNew');

  const gameEl=$('game');
  const setupEl=$('setup');
  const leftCol=document.querySelector('.leftCol');

  const currentPlayerNameEl=$('currentPlayerName');
  const roundNowEl=$('roundNow');
  const roundMaxEl=$('roundMax');
  const incomeEl=$('income');
  const expenseEl=$('expense');
  const balanceEl=$('balance');
  const networthEl=$('networth');
  const stockSummaryEl=$('stockSummary');
  const chipDepositEl=$('chipDeposit');           // ğŸ†•
  const chipLoanEl=$('chipLoan');                 // ğŸ†•

  const diceEl=$('dice');
  const resultEl=$('result');
  const cardEl=$('card');
  const cardAvatarEl=$('cardAvatar');
  const characterNameEl=$('characterName');
  const cardTitleEl=$('cardTitle');
  const cardTextEl=$('cardText');
  const cardAmountEl=$('cardAmount');

  const stockActionsEl=$('stockActions');
  const stockPriceEl=$('stockPrice');
  const stockQtyEl=$('stockQty');
  const stockSelectEl=$('stockSelect');
  const btnBuy=$('btnBuy');
  const btnSell=$('btnSell');
  const holdingsEl=$('holdings');

  const bankActionsEl=$('bankActions');          // ğŸ†•
  const bankAmtEl=$('bankAmt');                  // ğŸ†•
  const btnDeposit=$('btnDeposit');              // ğŸ†•
  const btnWithdraw=$('btnWithdraw');            // ğŸ†•
  const btnContinue=$('btnContinue');            // ğŸ†•
  const bankBalEl=$('bankBal');                  // ğŸ†•

  const buyBtn=$('buyBtn');
  const okBtn=$('okBtn');
  const nextBtn=$('nextBtn');

  const boardEl=$('board');
  const tileInfoEl=$('tileInfo');
  const ledgerEl=$('ledger');
  const leaderboardEl=$('leaderboard');
  const bankPanelEl=$('bankPanel');              // ğŸ†•
  const testOutput=$('testOutput');

  // ========= ç‹€æ…‹ =========
  let players=[]; let currentIndex=0; let gameOver=false;
  let roundNow=1; let roundMax=100; let winTarget=0;
  const allLedger=[];
  const GRID=8;
  let marketTimer=null;
  let blockRoll=false;           // ğŸ†• å¡ç‰‡é˜»æ“‹éª°å­ï¼ˆéŠ€è¡Œ/æŠ•è³‡çµæœ/ä½é™¢ï¼‰
  let deferredMove=null;         // ğŸ†• {pIndex, roll} éŠ€è¡Œè™•ç†å®Œæ‰çµç®—çš„é‚£ä¸€æ­¥

  // === è‚¡ç¥¨å¸‚å ´ï¼š20 æª” + æ®–åˆ©ç‡/åœç‰Œ/åç§» ===
  const MARKET={
    list: [
      {symbol:'LION', name:'é›„ç…'}, {symbol:'BEAR', name:'æ£•ç†Š'}, {symbol:'FOX', name:'ç‹ç‹¸'},
      {symbol:'CAT', name:'å°è²“'}, {symbol:'DOG', name:'å°ç‹—'}, {symbol:'RABT', name:'å°å…”'},
      {symbol:'TIGR', name:'è€è™'}, {symbol:'PAND', name:'ç†Šè²“'}, {symbol:'DEER', name:'æ¢…èŠ±é¹¿'},
      {symbol:'WOLF', name:'ç°ç‹¼'}, {symbol:'EAGL', name:'è€é·¹'}, {symbol:'OWLS', name:'è²“é ­é·¹'},
      {symbol:'DOLP', name:'æµ·è±š'}, {symbol:'SEAL', name:'æµ·è±¹'}, {symbol:'PENG', name:'ä¼éµ'},
      {symbol:'KOAL', name:'ç„¡å°¾ç†Š'}, {symbol:'SLOV', name:'æ¨¹æ‡¶'}, {symbol:'MICE', name:'å°é¼ '},
      {symbol:'HORS', name:'é§¿é¦¬'}, {symbol:'ZEBR', name:'æ–‘é¦¬'}
    ],
    price: {},
    yield: {},        // ğŸ†• å¹´æ®–åˆ©ç‡ï¼ˆ0.02~0.06ï¼‰
    halt: {},         // ğŸ†• {sym: periodsLeft}
    bias: {},         // ğŸ†• {sym: {drift, left}}
    init(){
      this.list.forEach((s,i)=>{
        this.price[s.symbol] = 60 + Math.round((i+1)* (240/this.list.length)) + Math.floor(Math.random()*20);
        this.yield[s.symbol] = 0.02 + Math.random()*0.04;
      });
      this.halt={}; this.bias={};
    },
    tickAll(){
      for(const s of this.list){
        const sym=s.symbol;
        if(this.halt[sym]>0){
          this.halt[sym]--; // åœç‰Œä¸­ï¼šä¸å‹•åƒ¹
          continue;
        }
        let drift = 0;
        if(this.bias[sym]?.left>0){
          drift = this.bias[sym].drift;
          this.bias[sym].left--;
          if(this.bias[sym].left<=0) delete this.bias[sym];
        }
        const base = (Math.random()*0.10)-0.05; // åŸºç¤ Â±5%
        let pct = base + drift;
        pct = Math.max(-PRICE_LIMIT, Math.min(PRICE_LIMIT, pct)); // æ¼²è·Œå¹…é™åˆ¶ Â±10%
        const p=this.price[sym];
        const np = Math.max(10, Math.round(p*(1+pct)));
        this.price[sym]=np;
      }
    },
    maybeNews(){
      if(Math.random() > NEWS_PROB_PER_TURN) return null;
      const s = this.list[Math.floor(Math.random()*this.list.length)];
      const sym = s.symbol;
      if(Math.random()<0.3){
        // åœç‰Œ 1~3 æœŸ
        const k = randInt(1,3);
        this.halt[sym] = Math.max(this.halt[sym]||0, k);
        return `ğŸ“° ${sym} åœç‰Œ ${k} æœŸï¼Œæš«åœäº¤æ˜“èˆ‡æ³¢å‹•ã€‚`;
      }else{
        // åˆ©å¤š/åˆ©ç©ºï¼šä¹‹å¾Œ 2~4 æœŸå¸¶åç§»ï¼ˆÂ±3%ï¼‰
        const left = randInt(2,4);
        const drift = (Math.random()<0.5?-1:1) * (0.015 + Math.random()*0.02); // 1.5%~3.5%
        this.bias[sym] = {drift, left};
        return `ğŸ“° ${sym} ${drift>0?'åˆ©å¤š':'åˆ©ç©º'}æ–°èï¼Œæœªä¾† ${left} æœŸèµ°å‹¢å${drift>0?'å¼·ğŸ“ˆ':'å¼±ğŸ“‰'}ã€‚`;
      }
    }
  };
  MARKET.init();

  // 8Ã—8 èºæ—‹è·¯å¾‘
  function spiralPath(n){
    const res=[]; let top=0,bottom=n-1,left=0,right=n-1;
    while(left<=right && top<=bottom){
      for(let c=left;c<=right;c++) res.push(top*n+c);
      for(let r=top+1;r<=bottom;r++) res.push(r*n+right);
      if(top<bottom){ for(let c=right-1;c>=left;c--) res.push(bottom*n+c); }
      if(left<right){ for(let r=bottom-1;r>top;r--) res.push(r*n+left); }
      top++; right--; bottom--; left++;
    }
    return res;
  }
  const PATH=spiralPath(GRID);

  // äº‹ä»¶å¡æ± ï¼ˆåŠ å…¥ä½é™¢/æŠ•è³‡ï¼‰
  const EVENTS=[
    { title:'æ‰“å·¥è³ºéŒ¢', text:'ä½ å»ä¾¿åˆ©å•†åº—æ‰“å·¥ã€‚', type:'income', amount:200 },
    { title:'å£“æ­²éŒ¢', text:'æ”¶åˆ°é˜¿å¬¤çš„ç´…åŒ…ã€‚', type:'income', amount:500 },
    { title:'æŠ•ç¨¿å¾—ç', text:'ç•«ç•«æŠ•ç¨¿ç²å¾—çé‡‘ã€‚', type:'income', amount:300 },
    { title:'å›æ”¶ç“¶ç½', text:'åšç’°ä¿ä¹Ÿèƒ½è³ºé›¶ç”¨éŒ¢ã€‚', type:'income', amount:120 },
    { title:'æ‰‹æ©Ÿç¶­ä¿®', text:'æ‰‹æ©Ÿå£äº†ï¼Œä»˜ç¶­ä¿®è²»ã€‚', type:'expense', amount:300 },
    { title:'éŠæ¨‚åœ’', text:'å’Œæœ‹å‹å‡ºéŠï¼Œé–€ç¥¨é¤é£²ã€‚', type:'expense', amount:400 },
    { title:'æ–‡å…·è£œçµ¦', text:'è²·ç­†è¨˜æœ¬èˆ‡é‰›ç­†ã€‚', type:'expense', amount:80 },
    { title:'åŒå­¸ç”Ÿæ—¥ç¦®', text:'æŒ‘å°ç¦®ç‰©æ…¶ç”Ÿã€‚', type:'expense', amount:150 },
    { title:'ç¤¾åœ˜è¡¨ç¾å„ªç§€', text:'è¢«è€å¸«è¡¨æšï¼Œå¾—åˆ°å°çé‡‘ã€‚', type:'income', amount:250 },
    { title:'éºå¤±è»Šç¥¨', text:'è£œè²·è»Šç¥¨ã€‚', type:'expense', amount:60 },
    // ğŸ†• ä½é™¢è·³é
    { title:'å—å‚·ä½é™¢', text:'ä¼‘æ¯ä¸¦è§€å¯Ÿï¼Œä¸‹ä¸€å›åˆè·³éä¸€æ¬¡ã€‚', type:'skip', skip:1 },
    // ğŸ†• æŠ•è³‡æ©Ÿæœƒï¼ˆå¯é¸ï¼‰
    { title:'æŠ•è³‡æ©Ÿæœƒ', text:'ä½ é‡åˆ°ä¸€å€‹æŠ•è³‡å°ˆæ¡ˆï¼Œæ˜¯å¦æŠ•å…¥ï¼Ÿä¸‹å›åˆè‡ªå‹•çµç®—ç›ˆè™§ã€‚', type:'invest' }
  ];

  // å»ºç›¤ï¼šå«åœ°ç”¢
  function buildTiles(len){
    const tiles=[{ name:'èµ·é»', type:'start' }];
    let propId=1;
    const weights={ salary:0.20, event:0.30, shop:0.10, stock:0.12, tax:0.08, donate:0.04, property:0.16 };
    const keys=Object.keys(weights);
    const pick=()=>{ let r=Math.random(); let acc=0; for(const k of keys){ acc+=weights[k]; if(r<=acc) return k; } return keys.at(-1); };
    for(let i=1;i<len;i++){
      const t=pick();
      if(t==='salary')       tiles.push({ name:Math.random()<0.5?'é›¶ç”¨é‡‘':'ç´…åˆ©', type:'salary', amount: randInt(180,420) });
      else if(t==='event')   tiles.push({ name:'äº‹ä»¶', type:'event' });
      else if(t==='shop')    tiles.push({ name:'å•†åº—', type:'shop', min:60, max:260 });
      else if(t==='stock')   tiles.push({ name:'è‚¡ç¥¨', type:'stock' });
      else if(t==='tax')     tiles.push({ name:'ç¨…é‡‘', type:'tax',  amount: randInt(80,180) });
      else if(t==='donate')  tiles.push({ name:'ææ¬¾', type:'donate',amount: randInt(60,140) });
      else if(t==='property'){
        const price=randInt(900,1800);
        const baseRent=Math.max(10, Math.floor(price*0.18));
        tiles.push({ name:`åœ°ç”¢ ${propId++}`, type:'property', price, baseRent, level:1, maxLevel:3, ownerIndex:null });
      }
    }
    return tiles;
  }
  let TILES=buildTiles(PATH.length);

  // === å¹«åŠ©è¨ˆç®—ï¼šåœ°ç”¢ / è‚¡ç¥¨ / æ·¨å€¼ / è²¸æ¬¾ ===
  function propertyValueForPlayer(playerIndex){
    let total=0;
    TILES.forEach(t=>{
      if(t.type==='property' && t.ownerIndex===playerIndex){
        total += (t.price||0) * (t.level||1);
      }
    });
    return total;
  }
  function stockValueOf(player){
    let total=0; if(!player?.stocks) return 0;
    for(const sym in player.stocks){
      const {qty=0}=player.stocks[sym]||{};
      const px = MARKET.price[sym]||0;
      total += qty * px;
    }
    return total;
  }
  function loansOutstanding(p){
    if(!p?.loans) return 0;
    return p.loans.reduce((s,l)=>s+(l.closed?0:l.principal),0);
  }
  function netWorthOf(player, playerIndex){
    return (player.balance||0) + (player.bankDeposit||0) + propertyValueForPlayer(playerIndex) + stockValueOf(player) - loansOutstanding(player);
  }

  // === UIï¼šè§’è‰²é ­åƒ
  function buildAvatars(){
    avatarsEl.innerHTML='';
    CHARACTERS.forEach(c=>{
      const div=document.createElement('button');
      div.type='button'; div.className='avatar';
      const imgWrap=document.createElement('div'); imgWrap.className='imgWrap'; div.appendChild(imgWrap);

      const visual=document.createElement('div'); visual.style.fontSize='64px'; visual.style.lineHeight='1'; visual.textContent=c.emoji; imgWrap.appendChild(visual);
      const img=new Image(); img.alt=c.name; img.onload=()=>visual.replaceWith(img); img.src=c.img;

      const picked=document.createElement('div'); picked.className='pickedName'; picked.textContent=''; imgWrap.appendChild(picked);
      const label=document.createElement('span'); label.textContent=c.name; div.appendChild(label);

      div.addEventListener('click',()=>{
        const customName=nameInput?.value.trim();
        if(!customName){ alert('è«‹å…ˆè¼¸å…¥åç¨±'); return; }
        if(players.length>=8){ alert('æœ€å¤š 8 ä½ç©å®¶'); return; }
        const stockBag={}; MARKET.list.forEach(s=>stockBag[s.symbol]={qty:0,avg:0});
        players.push({
          name:customName, img:(img.src||''), income:0, expense:0, balance:0, ledger:[],
          pos:0, stocks: stockBag,
          bankDeposit:0, loans:[], skipTurns:0, pendingInvest:null    // ğŸ†•
        });
        picked.textContent=customName;
        div.classList.add('selected'); div.disabled=true;
        nameInput.value='';
        renderBoard(); renderStats();
      });

      avatarsEl.appendChild(div);
    });
  }

  // === æ£‹ç›¤ç¹ªè£½ ===
  function renderBoard(){
    if(!boardEl){ console.error('æ‰¾ä¸åˆ° #board'); return; }
    boardEl.innerHTML='';
    const total = GRID*GRID;
    for(let i=0;i<total;i++){
      const cell=document.createElement('div'); cell.className='cell'; cell.dataset.idx=i;
      boardEl.appendChild(cell);
    }
    for(let k=0;k<TILES.length;k++){
      const boardIndex = PATH[k];
      const cell=boardEl.querySelector(`.cell[data-idx="${boardIndex}"]`);
      if(!cell){ continue; }
      const t=TILES[k];
      const tile=document.createElement('div'); tile.className='tile';

      let own = '';
      if(t.type==='property'){
        const lv = t.level || 1;
        own = (t.ownerIndex!=null) ? `<span style="float:right">ğŸ x${lv}</span>` : '<span style="float:right">ğŸ </span>';
      }

      let sub='';
      if(t.type==='property'){
        const rent = (t.baseRent||0) * (t.level||1);
        sub = `<small style="margin-left:6px">$ ${money(t.price)} / ç§Ÿ $ ${money(rent)}</small>`;
      } else if(t.amount){
        sub = `<small style="margin-left:6px">$ ${money(t.amount)}</small>`;
      }
      tile.innerHTML=`<h4>${k+1}. ${t.name} ${own} ${sub}</h4><div class="pills" id="tile-${k}"></div>`;
      cell.innerHTML=''; cell.appendChild(tile);
    }

    // ç©å®¶æ¨™è¨˜ + åç¨±
    players.forEach((pl)=>{
      const wrap=document.getElementById('tile-'+(pl.pos||0));
      if(wrap){
        const pill=document.createElement('span'); pill.className='pill';
        const top = document.createElement('span'); top.textContent='â—';
        const nm = document.createElement('span'); nm.className='nm'; nm.textContent=(pl.name||'P').slice(0,6);
        pill.appendChild(top); pill.appendChild(nm);
        wrap.appendChild(pill);
      }
    });

    const cp=players[currentIndex];
    if(cp){ const t=TILES[cp.pos||0]; tileInfoEl.textContent=`ä½ç½®ï¼šç¬¬ ${(cp.pos||0)+1} æ ¼ï¼ˆ${t.name}ï¼‰`; }
  }

  // === éŠ€è¡Œï¼šå­˜æ¬¾/è²¸æ¬¾è™•ç† ===
  function renderBankPanel(){
    const p=players[currentIndex]; if(!p) return;
    const rows = (p.loans||[]).filter(l=>!l.closed && l.remainingPeriods>0).map(l=>{
      return `<tr>
        <td>${(l.kind||'ä¸€èˆ¬')}</td>
        <td>${(l.years||'?')} å¹´</td>
        <td>${(l.apr*100).toFixed(2)}%</td>
        <td>$ ${money(l.principal)}</td>
        <td>${l.remainingPeriods}</td>
        <td>$ ${money(l.payment)}</td>
      </tr>`;
    }).join('');
    bankPanelEl.innerHTML = `
      <div>å­˜æ¬¾é¤˜é¡ï¼š$ <b>${money(p.bankDeposit||0)}</b></div>
      <table style="width:100%;border-collapse:collapse;margin-top:6px">
        <thead><tr><th align="left">è²¸æ¬¾åˆ¥</th><th>å¹´é™</th><th>å¹´åˆ©ç‡</th><th>å‰©é¤˜æœ¬é‡‘</th><th>å‰©é¤˜æœŸæ•¸</th><th>æ¯æœŸæ‡‰ç¹³</th></tr></thead>
        <tbody>${rows||`<tr><td colspan="6" style="text-align:center;color:#64748b">ç›®å‰ç„¡æœªæ¸…è²¸æ¬¾</td></tr>`}</tbody>
      </table>
    `;
  }
  function processDepositPeriod(p){
    const dep = p.bankDeposit || 0;
    if(dep>0){
      const interest = Math.round(dep * (DEPOSIT_APR/PERIODS_PER_YEAR));
      p.bankDeposit += interest;
      p.income += interest;
      pushLedger(p, '-', 'å­˜æ¬¾åˆ©æ¯', +interest);
    }
  }
  function processLoansPeriod(p){
    if(!p.loans) return;
    for(const l of p.loans){
      if(l.closed || l.remainingPeriods<=0) continue;
      const interest = Math.round(l.principal * (l.apr/PERIODS_PER_YEAR));
      const principalPay = Math.max(0, Math.min(l.principal, l.payment - interest));
      const pay = principalPay + interest;
      p.balance -= pay; p.expense += pay;
      l.principal = Math.max(0, l.principal - principalPay);
      l.remainingPeriods--;
      pushLedger(p, '-', `${l.kind||'è²¸æ¬¾'}ç¬¬${(l.origPeriods-l.remainingPeriods)}/${l.origPeriods}æœŸï¼šæœ¬æ¯`, -pay);
      if(l.principal<=0 || l.remainingPeriods<=0){
        l.closed=true; l.principal=0; l.remainingPeriods=0;
        pushLedger(p, '-', `${l.kind||'è²¸æ¬¾'}çµæ¸…`, 0);
      }
    }
  }
  function openBankPanel(p, afterFn){
    blockRoll=true;
    bankActionsEl.style.display='flex';
    stockActionsEl.style.display='none';
    buyBtn.style.display='none';
    holdingsEl.style.display='none';
    cardEl.style.display='block';
    cardTitleEl.textContent='ğŸ¦ éŠ€è¡Œ';
    cardAvatarEl.src = p.img || svgAnimal('ğŸ¦','#ddd');
    characterNameEl.textContent=p.name;
    cardAmountEl.textContent='';
    bankBalEl.textContent = money(p.bankDeposit||0);
    cardTextEl.innerHTML = `å®Œæˆä¸€åœˆï¼š<br>
      â€¢ å­˜æ¬¾åˆ©æ¯å·²å…¥å¸³ï¼ˆå¹´åˆ©ç‡ ${(DEPOSIT_APR*100).toFixed(2)}%ï¼‰<br>
      â€¢ è²¸æ¬¾å·²æ‰£æœ¬æ¯ï¼ˆå‰©é¤˜æœŸæ•¸è¦‹ä¸‹æ–¹æ˜ç´°ï¼‰`;
    okBtn.style.display='none';
    nextBtn.style.display='none';

    btnDeposit.onclick=()=>{
      const amt = Math.max(0, parseInt(bankAmtEl.value||'0',10));
      if(amt<=0) return;
      if(p.balance<amt){ alert('ç¾é‡‘ä¸è¶³ï¼Œç„¡æ³•å­˜å…¥ã€‚'); return; }
      p.balance -= amt; p.bankDeposit = (p.bankDeposit||0)+amt;
      pushLedger(p, '-', 'å­˜æ¬¾', -amt);
      bankBalEl.textContent=money(p.bankDeposit);
      renderStats();
    };
    btnWithdraw.onclick=()=>{
      const amt = Math.max(0, parseInt(bankAmtEl.value||'0',10));
      if(amt<=0) return;
      if((p.bankDeposit||0)<amt){ alert('å­˜æ¬¾ä¸è¶³ï¼Œç„¡æ³•æé ˜ã€‚'); return; }
      p.bankDeposit -= amt; p.balance += amt;
      pushLedger(p, '-', 'æé ˜', +amt);
      bankBalEl.textContent=money(p.bankDeposit);
      renderStats();
    };
    btnContinue.onclick=()=>{
      bankActionsEl.style.display='none';
      blockRoll=false;
      if(typeof afterFn==='function') afterFn();
      else cardEl.style.display='none';
    };
  }
  function createLoan(p, amount, apr, years, kind){
    const n = Math.max(1, Math.round(years*PERIODS_PER_YEAR));
    const payment = amortizedPayment(amount, apr, years);
    const loan = {kind, principal:amount, apr, years, payment, remainingPeriods:n, origPeriods:n, closed:false};
    p.loans.push(loan);
    p.balance += amount;
    pushLedger(p, '-', `${kind||'è²¸æ¬¾'}æ ¸è²¸ï¼ˆ${years}å¹´ï¼Œ${(apr*100).toFixed(2)}%ï¼‰`, +amount);
    return loan;
  }

  // === çµ±è¨ˆ ===
  function renderStats(){
    const p=players[currentIndex];
    currentPlayerNameEl.textContent=p?.name||'';
    incomeEl.textContent=money(p?.income??0);
    expenseEl.textContent=money(p?.expense??0);
    balanceEl.textContent=money(p?.balance??0);
    chipDepositEl.textContent=money(p?.bankDeposit??0);     // ğŸ†•
    chipLoanEl.textContent=money(loansOutstanding(p));      // ğŸ†•
    renderBankPanel();                                      // ğŸ†•

    if(p){
      const pv = propertyValueForPlayer(currentIndex);
      const sv = stockValueOf(p);
      const nw = (p.balance||0) + (p.bankDeposit||0) + pv + sv - loansOutstanding(p);
      networthEl.textContent = money(nw);
      const held = Object.entries(p.stocks).filter(([sym,obj])=>(obj?.qty||0)>0).slice(0,4).map(([sym,obj])=>`${sym}:${obj.qty}`).join('ï¼Œ');
      stockSummaryEl.textContent = held || 'â€”';
    }else{
      networthEl.textContent = '0';
      stockSummaryEl.textContent = 'â€”';
    }

    // æ˜ç´°
    ledgerEl.innerHTML='';
    if(p){
      p.ledger.slice().reverse().forEach(item=>{
        const li=document.createElement('li');
        li.textContent=`${item.time}ï½œ${p.name}ï½œğŸ²${item.roll}ï½œ${item.title}ï¼š${item.type==='income'?'+':'-'}${money(item.amount)}ï½œé¤˜é¡ ${money(item.balance)}`;
        li.style.color=item.type==='income'?'var(--good)':'var(--bad)';
        ledgerEl.appendChild(li);
      });
    }
    // æ’è¡Œï¼ˆä¾è³‡ç”¢æ·¨å€¼æ’åºï¼Œå«è‚¡ç¥¨å¸‚å€¼ã€å­˜æ¬¾ã€è² å‚µï¼‰
    leaderboardEl.innerHTML='';
    const ranked = players.map((pp,idx)=>{
      const pv=propertyValueForPlayer(idx), sv=stockValueOf(pp);
      const nw = (pp.balance||0)+(pp.bankDeposit||0)+pv+sv - loansOutstanding(pp);
      return {pp, idx, pv, sv, nw};
    }).sort((a,b)=>b.nw-a.nw);
    ranked.forEach(r=>{
      const li=document.createElement('li'); 
      li.textContent=`${r.pp.name}ï¼šæ·¨å€¼ ${money(r.nw)}ï¼ˆç¾é‡‘ ${money(r.pp.balance)}ï½œå­˜æ¬¾ ${money(r.pp.bankDeposit)}ï½œåœ°ç”¢ ${money(r.pv)}ï½œè‚¡ç¥¨ ${money(r.sv)}ï½œè²¸æ¬¾ ${money(loansOutstanding(r.pp))}ï¼‰`;
      leaderboardEl.appendChild(li);
    });

    roundNowEl.textContent=roundNow; roundMaxEl.textContent=roundMax;
    renderBoard();
  }

  function pushLedger(p, roll, title, delta){
    const entry={ time:nowStr(), player:p.name, roll, title, type: delta>=0?'income':'expense', amount:Math.abs(delta), balance: Math.round(p.balance) };
    p.ledger.push(entry); allLedger.push(entry);
  }

  // === è‚¡ç¥¨ï¼šæŒè‚¡è¡¨ ===
  function renderHoldings(p, highlightSym=null){
    const rows = [];
    let any=false;
    for(const s of MARKET.list){
      const sym=s.symbol;
      const {qty=0, avg=0} = p.stocks[sym]||{};
      if(qty>0){
        any=true;
        const px = MARKET.price[sym]||0;
        const pl = (px-avg)*qty;
        rows.push(
          `<tr${highlightSym===sym?' style="background:#f3f7ff"':''}>
            <td>${sym}${MARKET.halt[sym]>0?'ï¼ˆåœç‰Œï¼‰':''}</td>
            <td>${qty}</td>
            <td>$ ${money(avg)}</td>
            <td>$ ${money(px)}</td>
            <td class="${pl>=0?'pl':'mn'}">${pl>=0?'+':''}$ ${money(Math.abs(pl))}</td>
          </tr>`
        );
      }
    }
    if(!any){
      holdingsEl.style.display='block';
      holdingsEl.innerHTML = `<em style="color:#64748b">å°šç„¡æŒè‚¡</em>`;
      return;
    }
    holdingsEl.style.display='block';
    holdingsEl.innerHTML = `
      <div style="font-weight:700;margin:6px 0 4px">æˆ‘çš„æŒè‚¡</div>
      <table>
        <thead><tr><th>ä»£è™Ÿ</th><th>æ•¸é‡</th><th>å¹³å‡æˆæœ¬</th><th>ç¾åƒ¹</th><th>æœªå¯¦ç¾æç›Š</th></tr></thead>
        <tbody>${rows.join('')}</tbody>
      </table>
    `;
  }

  // === å‹åˆ©ï¼ˆè‹¥ winTarget>0 æ‰å•Ÿç”¨ï¼‰ ===
  function checkNetworthWin(p, pIndex){
    const nw = netWorthOf(p, pIndex);
    if(winTarget>0 && nw>=winTarget){
      alert(`ğŸ‰ æ­å–œ ${p.name} è³‡ç”¢æ·¨å€¼é”åˆ° $${money(winTarget)}ï¼Œç²å‹ï¼`);
      gameOver=true;
      stopMarketTimer();
      return true;
    }
    return false;
  }

  // === è‚¡ç¥¨/åœ°ç”¢ç”¨ï¼šä¸è¶³æ™‚å¯ä»¥è²¸æ¬¾ ===
  function ensureFundsWithLoan(p, needed, kind){
    if(needed<=0) return true;
    // å…ˆè©¢å•æ˜¯å¦å‹•ç”¨å­˜æ¬¾
    if((p.bankDeposit||0)>0){
      const useDep = confirm(`éœ€è¦ $${money(needed)}ã€‚è¦å…ˆå¾å­˜æ¬¾æé ˜å—ï¼Ÿ`);
      if(useDep){
        const amt = Math.min(needed, p.bankDeposit);
        p.bankDeposit -= amt; p.balance += amt;
        pushLedger(p, '-', 'æé ˜ï¼ˆè³¼è²·ç”¨é€”ï¼‰', +amt);
        needed -= amt;
      }
    }
    if(needed<=0) return true;
    // å•æ˜¯å¦è²¸æ¬¾
    if(confirm(`ä»å·® $${money(needed)}ã€‚è¦ç”³è«‹${kind}è²¸æ¬¾å—ï¼Ÿ`)){
      let years = parseInt(prompt('è«‹è¼¸å…¥è²¸æ¬¾å¹´é™ï¼ˆ1-5 å¹´ï¼‰ï¼š','3')||'3',10);
      years = clamp(years,1,5);
      const apr = (kind==='åœ°ç”¢è²¸æ¬¾')? MORTGAGE_APR : MARGIN_APR;
      const loan = createLoan(p, needed, apr, years, kind);
      renderStats();
      return true;
    }
    return false;
  }

  // === äº‹ä»¶è™•ç† ===
  function applyTileEffect(p, roll){
    const tile=TILES[p.pos||0];
    buyBtn.style.display='none'; buyBtn.onclick=null;
    stockActionsEl.style.display='none';
    holdingsEl.style.display='none';
    bankActionsEl.style.display='none';
    btnBuy.onclick=null; btnSell.onclick=null;

    let title=''; let text=''; let delta=0;

    switch(tile.type){
      case 'start':
        title='èµ·é»'; text='å›åˆ°èµ·é»ï¼Œæ·±å‘¼å¸æº–å‚™å‡ºç™¼ã€‚'; delta=0; break;

      case 'salary': {
        const amt=tile.amount;
        title=tile.name; text='é ˜åˆ°é›¶ç”¨é‡‘/ç´…åˆ©ï¼'; delta=+amt; p.income+=amt; p.balance+=amt; break; }

      case 'tax': {
        const amt=tile.amount;
        title=tile.name; text='ç¹³äº¤ç¨…é‡‘ã€‚'; delta=-amt; p.expense+=amt; p.balance-=amt; break; }

      case 'donate': {
        const amt=tile.amount;
        title=tile.name; text='åšå…¬ç›Šææ¬¾ï¼Œå¹«åŠ©éœ€è¦çš„äººã€‚'; delta=-amt; p.expense+=amt; p.balance-=amt; break; }

      case 'shop': {
        const cost=randInt(tile.min, tile.max);
        title='è³¼ç‰©èŠ±è²»'; text='åœ¨å•†åº—è²·äº†éœ€è¦çš„æ±è¥¿ã€‚'; delta=-cost; p.expense+=cost; p.balance-=cost; break; }

      case 'stock': {
        // ä¸‹æ‹‰æ¸…å–®
        stockSelectEl.innerHTML='';
        MARKET.list.forEach(s=>{
          const opt=document.createElement('option');
          opt.value=s.symbol; opt.textContent=`${s.symbol}ï¼ˆ${s.name}ï¼‰${MARKET.halt[s.symbol]>0?'ã€åœç‰Œã€‘':''}`;
          stockSelectEl.appendChild(opt);
        });
        stockSelectEl.selectedIndex = Math.floor(Math.random()*MARKET.list.length);

        const updatePriceUI = () => {
          const sym = stockSelectEl.value;
          const px = MARKET.price[sym];
          stockPriceEl.textContent = '$ ' + money(px);
          stockQtyEl.value = 1;
          const halted = MARKET.halt[sym]>0;
          btnBuy.disabled = btnSell.disabled = halted;
          cardTextEl.innerHTML = halted
            ? `ğŸ“› ${sym} ç›®å‰åœç‰Œä¸­ï¼Œæš«åœäº¤æ˜“ã€‚`
            : `æ¨è–¦æ¨™çš„ï¼š<b>${sym}</b>ï¼ˆå¯æ”¹é¸ï¼‰ï¼Œç›®å‰å¸‚åƒ¹ $ ${money(px)}ã€‚`;
          renderHoldings(p, sym);
        };
        updatePriceUI();

        title=`è‚¡ç¥¨ï¼šè²·è³£`;
        delta=0;
        stockActionsEl.style.display='flex';
        stockSelectEl.onchange = updatePriceUI;

        // è²·å…¥ï¼šæ›´æ–°åŠ æ¬Šå¹³å‡æˆæœ¬ï¼›ä¸è¶³å¯è²¸æ¬¾ï¼ˆèè³‡ï¼‰
        btnBuy.onclick=()=>{
          const sym = stockSelectEl.value;
          if(MARKET.halt[sym]>0){ alert('æ­¤è‚¡åœç‰Œï¼Œç¦æ­¢äº¤æ˜“ã€‚'); return; }
          const qty = Math.max(1, parseInt(stockQtyEl.value||'1',10));
          const px = MARKET.price[sym];
          const cost = qty * px;
          let need = cost - p.balance;
          if(need>0){
            const ok = ensureFundsWithLoan(p, need, 'è‚¡ç¥¨èè³‡');
            if(!ok) return updatePriceUI();
          }
          // é‡æ–°è¨ˆç®—ï¼ˆå¯èƒ½å‰›è²¸æ¬¾/æé ˜ï¼‰
          const cur = p.stocks[sym] || {qty:0,avg:0};
          const newQty = cur.qty + qty;
          const newAvg = newQty>0 ? Math.round(((cur.qty*cur.avg) + cost) / newQty) : 0;

          p.stocks[sym] = { qty:newQty, avg:newAvg };
          p.balance -= cost; p.expense += cost;

          pushLedger(p, roll, `è²·å…¥ ${sym} ${qty} è‚¡ï¼ˆ$ ${money(px)}ï¼‰`, -cost);
          renderStats();
          updatePriceUI();
          cardTextEl.textContent = `è²·å…¥æˆåŠŸï¼Œ${sym} æŒæœ‰ ${newQty} è‚¡ï¼Œå¹³å‡æˆæœ¬ $ ${money(newAvg)}ã€‚`;
          checkNetworthWin(p, currentIndex);
        };

        // è³£å‡ºï¼šä¸æ›´å‹• avg
        btnSell.onclick=()=>{
          const sym = stockSelectEl.value;
          if(MARKET.halt[sym]>0){ alert('æ­¤è‚¡åœç‰Œï¼Œç¦æ­¢äº¤æ˜“ã€‚'); return; }
          const qty = Math.max(1, parseInt(stockQtyEl.value||'1',10));
          const cur = p.stocks[sym] || {qty:0,avg:0};
          if(cur.qty < qty){ alert('æŒè‚¡ä¸è¶³ã€‚'); return; }

          const px = MARKET.price[sym];
          const proceeds = qty * px;
          const remainQty = cur.qty - qty;
          p.stocks[sym] = { qty: remainQty, avg: cur.avg };
          p.balance += proceeds; p.income += proceeds;

          pushLedger(p, roll, `è³£å‡º ${sym} ${qty} è‚¡ï¼ˆ$ ${money(px)}ï¼‰`, +proceeds);
          renderStats();
          updatePriceUI();
          cardTextEl.textContent = `è³£å‡ºæˆåŠŸï¼Œ${sym} å‰©é¤˜ ${remainQty} è‚¡ã€‚`;
          checkNetworthWin(p, currentIndex);
        };
        break;
      }

      case 'property': {
        const me=currentIndex;
        const owner=tile.ownerIndex;
        const rent = (tile.baseRent||0) * (tile.level||1);
        const upgradeCost = Math.floor(tile.price * 0.6);

        if(owner==null){
          title=tile.name; text=`ç„¡äººæ“æœ‰ï¼Œå¯è³¼è²·ï¼ˆåƒ¹æ ¼ $ ${money(tile.price)}ï¼Œç§Ÿé‡‘ $ ${money(rent)}ï¼‰ã€‚`;
          delta=0;
          buyBtn.style.display='inline-block';
          buyBtn.textContent = `è³¼è²·ï¼ˆ$ ${money(tile.price)}ï¼‰`;
          buyBtn.onclick=()=>{
            let need = tile.price - p.balance;
            if(need>0){
              const ok = ensureFundsWithLoan(p, need, 'åœ°ç”¢è²¸æ¬¾');
              if(!ok) return;
            }
            p.expense += tile.price; p.balance -= tile.price;
            pushLedger(p, roll, `è³¼è²· ${tile.name}`, -tile.price);
            tile.ownerIndex = me; renderStats();
            cardTextEl.textContent = `å·²è³¼è²· ${tile.name}ï¼ç›®å‰ç­‰ç´š Lv${tile.level}ï¼Œç§Ÿé‡‘ $ ${money(rent)}ã€‚`;
            buyBtn.style.display='none';
            checkNetworthWin(p, currentIndex);
          };
        } else if(owner!==me){
          title=tile.name; text=`æ­¤åœ°ç”¢å±¬æ–¼ ${players[owner].name}ï¼Œéœ€æ”¯ä»˜ç§Ÿé‡‘ $ ${money(rent)}ã€‚`;
          delta=-rent; p.expense+=rent; p.balance-=rent; players[owner].income+=rent; players[owner].balance+=rent;
        } else {
          title=tile.name; text=`ä½ æ“æœ‰é€™å€‹åœ°ç”¢ï¼ˆLv${tile.level}/${tile.maxLevel}ï¼‰ï¼Œå¯é¸æ“‡å‡ç´šæé«˜ç§Ÿé‡‘ã€‚`;
          delta=0;
          if(tile.level < tile.maxLevel){
            buyBtn.style.display='inline-block';
            buyBtn.textContent = `å‡ç´šè‡³ Lv${tile.level+1}ï¼ˆ$ ${money(upgradeCost)}ï¼‰`;
            buyBtn.onclick=()=>{
              let need = upgradeCost - p.balance;
              if(need>0){
                const ok = ensureFundsWithLoan(p, need, 'åœ°ç”¢è²¸æ¬¾');
                if(!ok) return;
              }
              p.expense += upgradeCost; p.balance -= upgradeCost;
              tile.level += 1;
              pushLedger(p, roll, `${tile.name} å‡ç´šè‡³ Lv${tile.level}`, -upgradeCost);
              renderStats();
              const newRent = (tile.baseRent||0) * (tile.level||1);
              cardTextEl.textContent = `å‡ç´šæˆåŠŸï¼æ–°ç§Ÿé‡‘ $ ${money(newRent)}ã€‚`;
              if(tile.level>=tile.maxLevel) buyBtn.style.display='none';
              checkNetworthWin(p, currentIndex);
            };
          } else {
            buyBtn.style.display='none';
          }
        }
        break;
      }

      case 'event': default: {
        const ev=EVENTS[Math.floor(Math.random()*EVENTS.length)];
        if(ev.type==='income' || ev.type==='expense'){
          title=ev.title; text=ev.text; delta= ev.type==='income'? ev.amount : -ev.amount;
          if(ev.type==='income'){p.income+=ev.amount;p.balance+=ev.amount;}else{p.expense+=ev.amount;p.balance-=ev.amount;}
        }else if(ev.type==='skip'){
          title=ev.title; text=ev.text; delta=0;
          p.skipTurns = (p.skipTurns||0) + (ev.skip||1);
          blockRoll=true; // è®“ç©å®¶çœ‹åˆ°æç¤º
        }else if(ev.type==='invest'){
          const investAmt = randInt(200,800);
          title=ev.title; text=`æ˜¯å¦æŠ•è³‡ $ ${money(investAmt)}ï¼Ÿä¸‹ä¸€æ¬¡è¼ªåˆ°ä½ æ™‚è‡ªå‹•çµç®—ç›ˆè™§ã€‚`; delta=0;
          buyBtn.style.display='inline-block';
          buyBtn.textContent='æˆ‘è¦æŠ•è³‡';
          buyBtn.onclick=()=>{
            if(p.balance < investAmt){
              const ok = ensureFundsWithLoan(p, investAmt - p.balance, 'ä¸€èˆ¬è²¸æ¬¾');
              if(!ok) return;
            }
            p.balance -= investAmt; p.expense += investAmt;
            p.pendingInvest = {amount:investAmt, placedAt:roundNow, status:'pending'};
            pushLedger(p, roll, 'æŠ•è³‡æŠ•å…¥', -investAmt);
            buyBtn.style.display='none';
            cardTextEl.textContent='å·²æŠ•å…¥ï¼Œç­‰ä¸‹å›åˆè‡ªå‹•çµç®—ã€‚';
            renderStats();
          };
        }
        break;
      }
    }

    // é¡¯ç¤ºå¡ç‰‡
    cardTitleEl.textContent=title;
    cardTextEl.textContent=text;
    cardAmountEl.textContent=(delta>=0?'æ”¶å…¥ +':'æ”¯å‡º ')+money(Math.abs(delta));
    cardAmountEl.style.color=delta>=0?'var(--good)':'var(--bad)';
    cardAvatarEl.src = p.img || svgAnimal('ğŸ™‚','#ddd');
    characterNameEl.textContent=p.name;
    cardEl.style.display='block';

    // è¨˜å¸³
    pushLedger(p, roll, title, delta);

    // æ·¨å€¼å‹åˆ©ï¼ˆè‹¥æœ‰è¨­å®šé–€æª»ï¼‰
    checkNetworthWin(p, currentIndex);
  }

  // === æ¯åœˆè™•ç†ï¼šéŠ€è¡Œåˆ©æ¯ + è‚¡åˆ© + è²¸æ¬¾æ”¤é‚„ ===
  function processLapFinancials(p){
    // å­˜æ¬¾åˆ©æ¯
    processDepositPeriod(p);
    // è‚¡åˆ©ï¼šä¾æŒè‚¡èˆ‡å¹´æ®–åˆ©ç‡ç™¼æ”¾ï¼ˆæ¯åœˆä¸€æ¬¡ï¼‰
    for(const s of MARKET.list){
      const sym=s.symbol;
      const cur = p.stocks[sym]||{qty:0};
      if(cur.qty>0){
        const px = MARKET.price[sym]||0;
        const div = Math.round(cur.qty * px * (MARKET.yield[sym]/PERIODS_PER_YEAR));
        if(div>0){
          p.balance += div; p.income += div;
          pushLedger(p, '-', `è‚¡åˆ© ${sym}`, +div);
        }
      }
    }
    // è²¸æ¬¾æœŸç¹³
    processLoansPeriod(p);
    renderStats();
  }

  // === é–‹å±€/çµæŸ/å›åˆ ===
  function startMarketTimer(){
    stopMarketTimer();
    marketTimer = setInterval(()=>{
      if(gameOver) return;
      MARKET.tickAll();
      renderStats();
      if(stockActionsEl.style.display!=='none'){
        const p=players[currentIndex];
        const sym = (document.getElementById('stockSelect')||{}).value;
        if(sym){
          document.getElementById('stockPrice').textContent = '$ ' + money(MARKET.price[sym]||0);
          renderHoldings(p, sym);
        }
      }
    }, 5000);
  }
  function stopMarketTimer(){
    if(marketTimer){ clearInterval(marketTimer); marketTimer=null; }
  }

  function startGame({reseed=false}={}){
    if(players.length<1){ alert('è«‹è‡³å°‘åŠ å…¥ 1 ä½ç©å®¶'); return; }
    roundMax = clamp(parseInt(roundLimitInput.value||'100',10),1,100);
    winTarget = Math.max(0, parseInt(winTargetInput.value||'0',10)); // 0=é—œé–‰
    const startMoney = Math.max(0, parseInt(startMoneyInput.value||'3000',10));

    roundNow=1; currentIndex=0; gameOver=false; allLedger.length=0;
    if(reseed){ TILES=buildTiles(PATH.length); MARKET.init(); }

    players = players.map(p=>{
      const bag={}; MARKET.list.forEach(s=>bag[s.symbol]={qty:0,avg:0});
      const np = { ...p, pos:0, income:0, expense:0, balance:startMoney, ledger:[], stocks:bag,
        bankDeposit:0, loans:[], skipTurns:0, pendingInvest:null };
      np.ledger.push({ time:nowStr(), player:np.name, roll:'-', title:'åˆå§‹è³‡é‡‘', type:'income', amount:startMoney, balance:startMoney });
      return np;
    });

    gameEl.style.display='block';
    if(leftCol && setupEl){ leftCol.appendChild(setupEl); }

    startMarketTimer();
    renderStats();
  }

  function endGameByRounds(){
    const ranked = players.map((pp,idx)=>{
      const pv=propertyValueForPlayer(idx), sv=stockValueOf(pp);
      const nw=(pp.balance||0)+(pp.bankDeposit||0)+pv+sv - loansOutstanding(pp);
      return {pp, idx, pv, sv, nw};
    }).sort((a,b)=>b.nw-a.nw);
    const top = ranked[0];
    alert(`â±ï¸ é”åˆ° ${roundMax} å›åˆï¼Œ${top.pp.name} ä»¥è³‡ç”¢æ·¨å€¼ ${money(top.nw)} å…ƒç²å‹ï¼ï¼ˆç¾é‡‘ ${money(top.pp.balance)}ï½œå­˜æ¬¾ ${money(top.pp.bankDeposit)}ï½œåœ°ç”¢ ${money(top.pv)}ï½œè‚¡ç¥¨ ${money(top.sv)}ï½œè²¸æ¬¾ ${money(loansOutstanding(top.pp))}ï¼‰`);
    gameOver=true;
    stopMarketTimer();
  }

  function maybeResolvePendingInvestment(){
    const p=players[currentIndex];
    if(!p?.pendingInvest || p.pendingInvest.status!=='pending') return false;
    // ä¸‹ä¸€æ¬¡è¼ªåˆ°è©²ç©å®¶ï¼šè‡ªå‹•çµç®—
    const amt = p.pendingInvest.amount;
    const ratio = (Math.random()<0.5 ? -1 : 1) * (0.10 + Math.random()*0.40); // -50% ~ +50%
    const profit = Math.round(amt * ratio);
    if(profit>=0){ p.balance += amt + profit; p.income += (amt + profit); }
    else{ p.balance += 0; p.expense += 0; /* å·²æ–¼æŠ•å…¥æ™‚æ‰£æ¬¾ï¼Œæå¤±ä¸é€€æœ¬é‡‘ */ }
    pushLedger(p, '-', `æŠ•è³‡çµç®—`, profit);
    cardEl.style.display='block';
    cardTitleEl.textContent='æŠ•è³‡çµæœ';
    cardTextEl.textContent=`æœ¬æ¬¡æŠ•è³‡çµæœï¼š${profit>=0?'ç²åˆ©':'è™§æ'} $ ${money(Math.abs(profit))}`;
    cardAmountEl.textContent = (profit>=0?'+':'-') + money(Math.abs(profit));
    cardAmountEl.style.color=profit>=0?'var(--good)':'var(--bad)';
    cardAvatarEl.src = p.img || svgAnimal('ğŸ’¼','#ddd');
    characterNameEl.textContent=p.name;
    p.pendingInvest=null;
    blockRoll=true;
    return true;
  }

  function advanceTurn(){
    cardEl.style.display='none'; if(!players.length || gameOver) return;
    currentIndex = (currentIndex + 1) % players.length;
    if(currentIndex===0){
      roundNow+=1;
      if(roundNow>roundMax){ endGameByRounds(); return; }
    }
    // ç©å®¶å›åˆé–‹å§‹ï¼šå¯èƒ½æ–°èäº‹ä»¶
    const news = MARKET.maybeNews();
    if(news){ resultEl.textContent = news; }
    renderStats(); resultEl.textContent = (news||'');

    // è‹¥éœ€è¦çµç®—æŠ•è³‡ï¼Œå…ˆé¡¯ç¤ºï¼›è‹¥ä½é™¢ï¼Œç›´æ¥è·³é
    if(maybeResolvePendingInvestment()){
      // é¡¯ç¤ºå®ŒæŠ•è³‡çµæœï¼Œç­‰å¾…ç©å®¶æŒ‰ã€ŒçŸ¥é“äº†ã€æ‰å¯æ“²éª°
      return;
    }
    const p=players[currentIndex];
    if(p.skipTurns>0){
      cardEl.style.display='block';
      cardTitleEl.textContent='ä¼‘æ¯ä¸€ä¸‹';
      cardTextEl.textContent='ä½ æ­£åœ¨ä½é™¢ä¼‘æ¯ï¼Œæœ¬å›åˆè·³éã€‚';
      cardAmountEl.textContent='';
      cardAvatarEl.src = p.img || svgAnimal('ğŸ›Œ','#ddd');
      characterNameEl.textContent=p.name;
      p.skipTurns--;
      blockRoll=true; // å¿…é ˆæŒ‰ã€Œä¸‹ä¸€ä½ã€æˆ–ã€ŒçŸ¥é“äº†ã€
    }else{
      blockRoll=false;
    }
  }

  // æ“²éª°
  diceEl.addEventListener('click',()=>{
    if(gameOver || blockRoll){ return; }
    if(!players.length){ alert('è«‹å…ˆåŠ å…¥ç©å®¶'); return; }

    // å¸‚å ´æ¯å›åˆä¹Ÿæ³¢å‹•ä¸€æ¬¡
    MARKET.tickAll();

    const p=players[currentIndex];
    const roll=Math.floor(Math.random()*6)+1; resultEl.textContent=`ä½ æ“²å‡ºäº†ï¼š${roll}`;
    const old = p.pos||0;
    const newPos = (old + roll) % PATH.length;
    const wrapped = (old + roll) >= PATH.length;

    p.pos = newPos; renderBoard();

    if(wrapped){
      // æ¯åœˆè™•ç†ï¼šå…ˆè¨ˆæ¯/è‚¡åˆ©/è²¸æ¬¾ï¼Œå†é–‹éŠ€è¡Œé¢æ¿ï¼Œæœ€å¾Œæ‰é€²æ ¼
      processLapFinancials(p);
      deferredMove = {pIndex: currentIndex, roll};
      openBankPanel(p, ()=>{ applyTileEffect(players[deferredMove.pIndex], deferredMove.roll); deferredMove=null; });
      return;
    }

    applyTileEffect(p, roll);
  });

  okBtn.addEventListener('click', ()=>{ blockRoll=false; cardEl.style.display='none'; });
  nextBtn.addEventListener('click', ()=>{ blockRoll=false; cardEl.style.display='none'; advanceTurn(); });

  quickNewBtn.addEventListener('click',()=>startGame({reseed:false}));
  reseedNewBtn.addEventListener('click',()=>startGame({reseed:true}));
  startBtn.addEventListener('click',()=>startGame({reseed:true}));

  // å•Ÿå‹•
  buildAvatars();
  renderBoard();
  renderStats();

  // åŸºæœ¬æ¸¬è©¦ï¼ˆç¶²å€åŠ  #testï¼‰
  function logTest(msg){ testOutput.style.display='block'; testOutput.textContent += msg + '\n'; }
  function runTests(){
    try{
      logTest('é–‹å§‹æ¸¬è©¦â€¦');
      console.assert(PATH.length===64,'PATH=64');
      const uniq=new Set(PATH); console.assert(uniq.size===64,'PATH ä¸é‡è¤‡');
      const tmp=buildTiles(PATH.length); console.assert(tmp.length===64,'TILES=64');
      // æ”¤é‚„æ¸¬è©¦
      const pay = amortizedPayment(12000, 0.06, 1); console.assert(pay>1000 && pay<1100,'amortized ~1033');
      logTest('âœ“ OK');
    }catch(e){ logTest('âŒ '+(e?.message||e)); }
  }
  if(location.hash==='#test'){ runTests(); }
});
</script>
</body>
</html>
