<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç†è²¡å°å¯Œç¿ï¼ˆå‹•ç‰©ç‰ˆï¼‰â€” 8Ã—8 èºæ—‹åœ°åœ– + åœ°ç”¢ + äº‹ä»¶å¡ + æ”¶æ”¯çµ±è¨ˆ</title>
<style>
  :root{
    --primary:#5d9cec; --panel:#ffffff; --bg:#f0f8ff; --ink:#0f172a; --muted:#64748b;
    --accent:#8fb3ff; --good:#2e7d32; --bad:#c62828;
  }
  *{box-sizing:border-box}
  body{font-family:"Noto Sans TC",Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0;padding:12px;text-align:center}
  h1{margin:6px 0 10px}
  .grid{display:grid;grid-template-columns:repeat(4, minmax(120px,1fr));gap:10px;max-width:1100px;margin:0 auto}
  .panel{background:var(--panel);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.12);padding:10px;text-align:left}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  label{font-size:14px}
  input,select{padding:6px;border-radius:8px;border:1px solid #cbd5e1}
  input[type=number]{width:90px}
  button{padding:8px 12px;border:0;border-radius:10px;background:var(--primary);color:#fff;font-size:14px;cursor:pointer}
  button.secondary{background:#e2e8f0;color:#111}
  button.ghost{background:transparent;border:1px solid #cbd5e1;color:#111}
  .avatar{border:2px solid transparent;border-radius:14px;background:#fff8dc;padding:8px;cursor:pointer;transition:transform .15s,border-color .2s;display:flex;flex-direction:column;align-items:center;gap:6px; width:140px}
  .avatar:hover{transform:translateY(-2px);border-color:var(--primary)}
  .avatar img{width:100%;height:auto;object-fit:contain;border-radius:10px}
  .avatar span{font-size:14px;font-weight:700}

  .stats{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin:6px auto}
  .chip{background:#fff;border-radius:999px;padding:6px 10px;box-shadow:0 2px 8px rgba(0,0,0,.07);font-size:13px}
  .good{color:var(--good)} .bad{color:var(--bad)}

  #dice{font-size:72px;cursor:pointer;user-select:none;margin-top:6px}
  #result{margin-top:6px;font-size:18px;font-weight:700}

  #card{display:none;border:2px solid var(--accent);padding:12px;margin:10px auto 0;width:min(920px,95vw);border-radius:14px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.12);text-align:left}
  #card h3{margin:4px 0 6px}
  #card .row{display:flex;gap:12px;align-items:center}
  #card .amount{font-weight:700}

  /* 8x8 èºæ—‹æ£‹ç›¤ */
  .board{margin:10px auto;display:grid;grid-template-columns:repeat(8, 52px);grid-template-rows:repeat(8, 52px);gap:4px;justify-content:center}
  .cell{background:#eaf4ff;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:10px;color:#333}
  .tile{background:#fff;border:2px solid var(--accent);border-radius:10px;padding:2px;width:100%;height:100%;display:flex;flex-direction:column;justify-content:space-between}
  .tile h4{margin:2px 4px;font-size:10px}
  .pills{display:flex;flex-wrap:wrap;gap:2px;padding:0 2px 2px}
  .pill{font-size:9px;background:#eef3ff;border:1px solid #c7d8ff;border-radius:999px;padding:1px 3px}
  #tileInfo{margin-top:6px;font-size:14px}

  details{max-width:1100px;margin:8px auto;text-align:left}
  summary{cursor:pointer}
  #ledger{max-height:220px;overflow:auto}
  #testOutput{max-width:1100px;margin:10px auto;text-align:left;white-space:pre-wrap;background:#fff;border:1px dashed #bbb;padding:8px;display:none}

  @media (max-width: 980px){
    .grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <h1>ğŸ² ç†è²¡å°å¯Œç¿ï¼ˆå‹•ç‰©ç‰ˆï¼‰</h1>

  <section class="grid">
    <div class="panel" id="setup">
      <h3>ç©å®¶èˆ‡è¦å‰‡</h3>
      <div class="row">
        <input id="nameInput" placeholder="è«‹è¼¸å…¥ç©å®¶åç¨±"/>
        <label>å›åˆä¸Šé™ï¼š<input type="number" id="roundLimit" min="1" max="50" value="20" style="width:80px"></label>
        <label>å‹åˆ©é‡‘é¡ï¼š<input type="number" id="winTarget" min="0" step="100" value="5000" style="width:90px"></label>
      </div>
      <div class="row">
        <label>æ£‹ç›¤é…ç½®ï¼š
          <select id="layoutMode">
            <option value="random">éš¨æ©Ÿï¼ˆæ¯å±€ä¸åŒï¼‰</option>
            <option value="fixed">å›ºå®šï¼ˆä¾ç¨®å­ï¼‰</option>
          </select>
        </label>
        <label>å›ºå®šç¨®å­ï¼š<input id="seedInput" placeholder="ä¾‹å¦‚ classA" style="width:120px"></label>
        <label><input type="checkbox" id="smoothOn" checked> å¹³æ»‘åˆ†ä½ˆï¼ˆé¿å…åŒé¡é€£çºŒè¶…é 2 æ ¼ï¼‰</label>
      </div>

      <details open>
        <summary>âš™ï¸ æ©Ÿç‡èˆ‡é‡‘é¡è¨­å®š</summary>
        <div class="row">
          <strong>æ ¼å­æ©Ÿç‡ï¼ˆ%ï¼‰</strong>
          <label>é›¶ç”¨é‡‘/ç´…åˆ© <input type="number" id="wSalary" value="25"></label>
          <label>äº‹ä»¶ <input type="number" id="wEvent" value="20"></label>
          <label>å•†åº— <input type="number" id="wShop" value="12"></label>
          <label>è‚¡ç¥¨ <input type="number" id="wStock" value="10"></label>
          <label>ç¨…é‡‘ <input type="number" id="wTax" value="8"></label>
          <label>ææ¬¾ <input type="number" id="wDonate" value="5"></label>
          <label>åœ°ç”¢ <input type="number" id="wProp" value="20"></label>
        </div>
        <div class="row">
          <strong>é‡‘é¡ç¯„åœ</strong>
          <label>é›¶ç”¨é‡‘/ç´…åˆ© <input type="number" id="salaryMin" value="180">ï½<input type="number" id="salaryMax" value="420"></label>
          <label>å•†åº—æ”¯å‡º <input type="number" id="shopMin" value="60">ï½<input type="number" id="shopMax" value="260"></label>
          <label>ç¨…é‡‘ <input type="number" id="taxMin" value="80">ï½<input type="number" id="taxMax" value="180"></label>
          <label>ææ¬¾ <input type="number" id="donateMin" value="60">ï½<input type="number" id="donateMax" value="140"></label>
          <label>è‚¡ç¥¨è®Šå‹• <input type="number" id="stockMin" value="-150">ï½<input type="number" id="stockMax" value="250"></label>
        </div>
        <div class="row">
          <strong>åœ°ç”¢</strong>
          <label>æˆ¿åƒ¹ <input type="number" id="propMin" value="600">ï½<input type="number" id="propMax" value="1400"></label>
          <label>ç§Ÿé‡‘ç‡(%) <input type="number" id="rentRate" value="18" style="width:70px"></label>
          <label>è³¼è²·éœ€è¶³å¤ é¤˜é¡ <input type="checkbox" id="needCash" checked></label>
        </div>
      </details>

      <p style="margin:6px 0">é»ä¸‹æ–¹å‹•ç‰©åŠ å…¥ï¼ˆæœ€å¤š 8 äººï¼‰ï¼š</p>
      <div id="avatars" class="row" style="justify-content:flex-start;flex-wrap:wrap"></div>
      <div class="row" style="margin-top:8px">
        <button id="startGame">é–‹å§‹éŠæˆ²</button>
        <button id="quickNew" class="secondary">æ–°å±€ï¼ˆä¿ç•™ç©å®¶ï¼Œä¸è®Šæ›´æ£‹ç›¤ï¼‰</button>
        <button id="reseedNew" class="secondary">æ–°å±€ï¼‹é‡æŠ½æ£‹ç›¤</button>
      </div>
    </div>

    <div class="panel" id="game" style="display:none">
      <h3>ç›®å‰ç©å®¶ï¼š <span id="currentPlayerName"></span></h3>
      <div class="row"><span>å›åˆï¼š<span id="roundNow">1</span>/<span id="roundMax">20</span></span></div>
      <div class="stats">
        <div class="chip good">ç¸½æ”¶å…¥ï¼š<span id="income">0</span></div>
        <div class="chip bad">ç¸½æ”¯å‡ºï¼š<span id="expense">0</span></div>
        <div class="chip">ç¾é‡‘é¤˜é¡ï¼š<strong id="balance">0</strong></div>
      </div>
      <div id="dice" title="é»æˆ‘æ“²éª°">ğŸ²</div>
      <div id="result"></div>
      <div id="card">
        <div class="row">
          <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
            <img id="cardAvatar" alt="è§’è‰²" style="width:72px;height:72px;border-radius:12px;object-fit:cover"/>
            <div id="characterName" style="font-weight:600"></div>
          </div>
          <div>
            <h3 id="cardTitle">äº‹ä»¶å¡</h3>
            <p id="cardText">å…§å®¹æœƒåœ¨é€™è£¡å‡ºç¾</p>
            <p class="amount" id="cardAmount"></p>
            <div class="row">
              <button id="buyBtn" class="secondary" style="display:none">è³¼è²·åœ°ç”¢</button>
              <button id="okBtn">çŸ¥é“äº†</button>
              <button id="nextBtn" class="secondary">ä¸‹ä¸€ä½</button>
            </div>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top:10px">
        <h4>8Ã—8 èºæ—‹æ£‹ç›¤ï¼ˆå¤–æ¡†â†’å‘å…§ï¼‰</h4>
        <div id="board" class="board"></div>
        <div id="tileInfo">ä½ç½®ï¼šâ€”</div>
      </div>

      <details>
        <summary>ğŸ“’ æ”¶æ”¯æ˜ç´°ï¼ˆç›®å‰ç©å®¶ï¼‰</summary>
        <ul id="ledger" style="text-align:left"></ul>
      </details>

      <details>
        <summary>ğŸ“Š æ’è¡Œï¼ˆå…¨é«”ï¼‰</summary>
        <ol id="leaderboard" style="text-align:left"></ol>
      </details>

      <div class="row" style="margin-top:6px">
        <button id="downloadCsv" class="ghost">ä¸‹è¼‰å…¨é«”æ”¶æ”¯æ˜ç´°ï¼ˆCSVï¼‰</button>
      </div>
    </div>
  </section>

  <div id="testOutput"></div>

<script>
addEventListener('DOMContentLoaded', () => {
  // ========== å°å·¥å…· ==========
  const $ = id => { const el = document.getElementById(id); if(!el){ console.error('ç¼ºå°‘å…ƒç´  #'+id); } return el; };
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const randInt=(min,max,rnd=Math.random)=>Math.floor(min + rnd()*(max-min+1));
  const money = n => Number(n).toLocaleString('zh-TW');

  // è§’è‰²åœ–ï¼šå…§åµŒ SVGï¼ˆemojiï¼‰+ å¾Œå‚™
  function svgAnimal(emoji, bg){
    const svg = `<?xml version='1.0' encoding='UTF-8'?>
      <svg xmlns='http://www.w3.org/2000/svg' width='400' height='400'>
        <rect width='100%' height='100%' rx='40' ry='40' fill='${bg}'/>
        <circle cx='200' cy='150' r='120' fill='rgba(255,255,255,0.85)' />
        <text x='50%' y='58%' dominant-baseline='middle' text-anchor='middle' font-size='160'>${emoji}</text>
      </svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  }
  const CHARACTERS = [
    { name: 'å°ç†Š',   emoji:'ğŸ»', bg:'#FFD166' },
    { name: 'å°å…”',   emoji:'ğŸ°', bg:'#EF476F' },
    { name: 'å°ç‹—',   emoji:'ğŸ¶', bg:'#06D6A0' },
    { name: 'å°è²“',   emoji:'ğŸ±', bg:'#118AB2' },
    { name: 'å°è±¡',   emoji:'ğŸ˜', bg:'#8ECAE6' },
    { name: 'å°ç‹ç‹¸', emoji:'ğŸ¦Š', bg:'#FFB703' },
    { name: 'å°é³¥',   emoji:'ğŸ¦', bg:'#A3D9A5' },
    { name: 'å°ä¼éµ', emoji:'ğŸ§', bg:'#CBD5E1' }
  ].map(c => ({ ...c, img: svgAnimal(c.emoji, c.bg) }));

  // ========== DOM åƒç…§ ==========
  const nameInput=$('nameInput');
  const roundLimitInput=$('roundLimit');
  const winTargetInput=$('winTarget');
  const layoutModeSel=$('layoutMode');
  const seedInput=$('seedInput');
  const smoothOn=$('smoothOn');
  const avatarsEl=$('avatars');
  const startBtn=$('startGame');
  const quickNewBtn=$('quickNew');
  const reseedNewBtn=$('reseedNew');

  const gameEl=$('game');
  const currentPlayerNameEl=$('currentPlayerName');
  const roundNowEl=$('roundNow');
  const roundMaxEl=$('roundMax');
  const incomeEl=$('income');
  const expenseEl=$('expense');
  const balanceEl=$('balance');
  const diceEl=$('dice');
  const resultEl=$('result');
  const cardEl=$('card');
  const cardAvatarEl=$('cardAvatar');
  const characterNameEl=$('characterName');
  const cardTitleEl=$('cardTitle');
  const cardTextEl=$('cardText');
  const cardAmountEl=$('cardAmount');
  const buyBtn=$('buyBtn');
  const okBtn=$('okBtn');
  const nextBtn=$('nextBtn');
  const ledgerEl=$('ledger');
  const leaderboardEl=$('leaderboard');
  const downloadBtn=$('downloadCsv');

  const boardEl=$('board');
  const tileInfoEl=$('tileInfo');
  const testOutput=$('testOutput');

  // è¨­å®šè¼¸å…¥
  const wSalary=$('wSalary'), wEvent=$('wEvent'), wShop=$('wShop'), wStock=$('wStock'), wTax=$('wTax'), wDonate=$('wDonate'), wProp=$('wProp');
  const salaryMin=$('salaryMin'), salaryMax=$('salaryMax');
  const shopMin=$('shopMin'), shopMax=$('shopMax');
  const taxMin=$('taxMin'), taxMax=$('taxMax');
  const donateMin=$('donateMin'), donateMax=$('donateMax');
  const stockMin=$('stockMin'), stockMax=$('stockMax');
  const propMin=$('propMin'), propMax=$('propMax'), rentRateEl=$('rentRate'), needCashEl=$('needCash');

  // ========== ç‹€æ…‹ ==========
  let players=[]; let roundNow=1; let roundMax=20; let winTarget=5000; let currentIndex=0; let gameOver=false;
  const allLedger=[]; // å…¨é«”æ”¶æ”¯ CSV

  // ç›¤é¢ï¼š8Ã—8 èºæ—‹
  const GRID=8;
  function spiralPath(n){
    const res=[]; let top=0,bottom=n-1,left=0,right=n-1;
    while(left<=right && top<=bottom){
      for(let c=left;c<=right;c++) res.push(top*n+c);
      for(let r=top+1;r<=bottom;r++) res.push(r*n+right);
      if(top<bottom){ for(let c=right-1;c>=left;c--) res.push(bottom*n+c); }
      if(left<right){ for(let r=bottom-1;r>top;r--) res.push(r*n+left); }
      top++; right--; bottom--; left++;
    }
    return res;
  }
  const PATH=spiralPath(GRID); // 64

  // äº‹ä»¶å¡ï¼ˆtile.type==='event' æ™‚ä½¿ç”¨ï¼‰
  const EVENTS=[
    { title:'æ‰“å·¥è³ºéŒ¢', text:'ä½ å»ä¾¿åˆ©å•†åº—æ‰“å·¥ã€‚', type:'income', amount:200 },
    { title:'æ‰‹æ©Ÿå£äº†', text:'æ‰‹æ©Ÿçªç„¶å£æ‰éœ€è¦ç¶­ä¿®ã€‚', type:'expense', amount:300 },
    { title:'å£“æ­²éŒ¢', text:'æ”¶åˆ°é˜¿å¬¤çš„ç´…åŒ…ã€‚', type:'income', amount:500 },
    { title:'éŠæ¨‚åœ’å‡ºéŠ', text:'å’Œæœ‹å‹å»éŠæ¨‚åœ’ç©ã€‚', type:'expense', amount:400 },
    { title:'å¹«å¿™é„°å±…', text:'å¹«å¿™ç…§é¡§å¯µç‰©å¾—åˆ°çå‹µã€‚', type:'income', amount:120 },
    { title:'æ–‡å…·è£œçµ¦', text:'è²·äº†æ–°é‰›ç­†å’Œç­†è¨˜æœ¬ã€‚', type:'expense', amount:80 }
  ];

  // ========== æ£‹ç›¤æ ¼ç”Ÿæˆï¼ˆæ©Ÿç‡ + å¹³æ»‘ï¼‰ ==========
  function mulberry32(seed){
    let a=(typeof seed==='number'?seed:String(seed).split('').reduce((s,ch)=>s+ch.charCodeAt(0),0))>>>0;
    return function(){ a+=0x6D2B79F5; let t=Math.imul(a^a>>>15,1|a); t^=t+Math.imul(t^t>>>7,61|t); return ((t^t>>>14)>>>0)/4294967296; };
  }
  function readConfig(){
    const weights={ salary:+wSalary.value||0, event:+wEvent.value||0, shop:+wShop.value||0, stock:+wStock.value||0, tax:+wTax.value||0, donate:+wDonate.value||0, property:+wProp.value||0 };
    const sum=Object.values(weights).reduce((a,b)=>a+b,0)||1; Object.keys(weights).forEach(k=>weights[k]=weights[k]/sum);
    return {
      weights,
      salary:[+salaryMin.value||180,+salaryMax.value||420],
      shop:[+shopMin.value||60,+shopMax.value||260],
      tax:[+taxMin.value||80,+taxMax.value||180],
      donate:[+donateMin.value||60,+donateMax.value||140],
      stock:[+stockMin.value||-150,+stockMax.value||250],
      property:{ price:[+propMin.value||600,+propMax.value||1400], rentRate:(+rentRateEl.value||18)/100 },
      needCash: !!needCashEl.checked,
      smooth: !!smoothOn.checked,
      maxRepeat: 2
    };
  }
  function weightedPick(rnd, weights){
    const keys=Object.keys(weights); let r=rnd(); let acc=0;
    for(const k of keys){ acc+=weights[k]; if(r<=acc) return k; }
    return keys[keys.length-1];
  }

  let TILES=[];
  function buildTiles(len, mode, seed){
    const cfg=readConfig();
    const tiles=[{ name:'èµ·é»', type:'start' }];
    let rnd=Math.random; if(mode==='fixed') rnd=mulberry32(seed||1);
    let propId=1;
    const lastTypes=[];
    for(let i=1;i<len;i++){
      let pick; let tries=0;
      do{
        pick=weightedPick(rnd,cfg.weights); tries++;
      } while(cfg.smooth && lastTypes.length>=cfg.maxRepeat && lastTypes.slice(-cfg.maxRepeat).every(t=>t===pick) && tries<30);

      if(pick==='salary')      tiles.push({ name:rnd()<0.5?'é›¶ç”¨é‡‘':'ç´…åˆ©', type:'salary', amount: randInt(cfg.salary[0], cfg.salary[1], rnd) });
      else if(pick==='shop')   tiles.push({ name:'å•†åº—', type:'shop', min:cfg.shop[0], max:cfg.shop[1] });
      else if(pick==='stock')  tiles.push({ name:'è‚¡ç¥¨', type:'stock', min:cfg.stock[0], max:cfg.stock[1] });
      else if(pick==='tax')    tiles.push({ name:'ç¨…é‡‘', type:'tax', amount: randInt(cfg.tax[0], cfg.tax[1], rnd) });
      else if(pick==='donate') tiles.push({ name:'ææ¬¾', type:'donate', amount: randInt(cfg.donate[0], cfg.donate[1], rnd) });
      else if(pick==='property'){
        const price=randInt(cfg.property.price[0], cfg.property.price[1], rnd);
        const rent=Math.max(10, Math.floor(price * cfg.property.rentRate));
        tiles.push({ name:`åœ°ç”¢ ${propId++}`, type:'property', price, rent, ownerIndex:null });
      } else                    tiles.push({ name:'äº‹ä»¶', type:'event' });

      lastTypes.push(pick);
    }
    return tiles;
  }

  // ========== UIï¼šè§’è‰²é ­åƒ ==========
  function buildAvatars(){
    avatarsEl.innerHTML='';
    CHARACTERS.forEach(c=>{
      const div=document.createElement('button');
      div.type='button';
      div.className='avatar';

      // é è¨­ emojiï¼ˆåœ–ç‰‡è¼‰å…¥å‰/å¤±æ•—çš„è¦–è¦ºï¼‰
      const visual=document.createElement('div');
      visual.style.fontSize='64px'; visual.style.lineHeight='1';
      visual.textContent=c.emoji;
      div.appendChild(visual);

      // å˜—è©¦è¼‰å…¥åœ–ç‰‡ï¼›æˆåŠŸå°±æ›¿æ› emoji
      const img=new Image();
      img.alt=c.name;
      img.onload=()=>{ visual.replaceWith(img); };
      img.onerror=()=>{ /* ä¿ç•™ emoji è¦–è¦º */ };
      img.src=c.img;

      const label=document.createElement('span');
      label.textContent=c.name;
      div.appendChild(label);

      div.addEventListener('click',()=>{
        const customName=nameInput?.value.trim();
        if(!customName){ alert('è«‹å…ˆè¼¸å…¥åç¨±'); return; }
        if(players.length>=8){ alert('æœ€å¤š 8 ä½ç©å®¶'); return; }
        players.push({ name:customName, img:(img.src||''), income:0, expense:0, balance:0, ledger:[], pos:0 });
        label.textContent=customName;
        if(nameInput) nameInput.value='';
        renderBoard();
      });

      avatarsEl.appendChild(div);
    });
  }

  // ========== æ£‹ç›¤ç¹ªè£½ ==========
  function renderBoard(){
    boardEl.innerHTML='';
    for(let i=0;i<GRID*GRID;i++){
      const cell=document.createElement('div'); cell.className='cell'; boardEl.appendChild(cell);
    }
    for(let k=0;k<TILES.length;k++){
      const gridIndex=PATH[k]; const cell=boardEl.children[gridIndex]; const tile=document.createElement('div'); tile.className='tile';
      const own=(TILES[k].type==='property' && TILES[k].ownerIndex!=null) ? `<span style="float:right">ğŸ </span>` : '';
      let sub='';
      if(TILES[k].type==='property'){ sub = `<small style="margin-left:6px">$${TILES[k].price}/ç§Ÿ$${TILES[k].rent}</small>`; }
      else if(TILES[k].amount){ sub = `<small style="margin-left:6px">$${TILES[k].amount}</small>`; }
      tile.innerHTML=`<h4>${k+1}. ${TILES[k].name} ${own}${sub}</h4><div class="pills" id="tile-${k}"></div>`;
      cell.innerHTML=''; cell.appendChild(tile);
    }
    players.forEach(pl=>{
      const wrap=document.getElementById('tile-'+(pl.pos||0));
      if(wrap){ const pill=document.createElement('span'); pill.className='pill'; pill.textContent=(pl.name||'P').slice(0,4); wrap.appendChild(pill); }
    });
    const cp=players[currentIndex];
    if(cp){ const t=TILES[cp.pos||0]; tileInfoEl.textContent=`ä½ç½®ï¼šç¬¬ ${(cp.pos||0)+1} æ ¼ï¼ˆ${t.name}ï¼‰`; }
  }

  // ========== ç‹€æ…‹å‘ˆç¾ ==========
  function renderStats(){
    const p=players[currentIndex];
    currentPlayerNameEl.textContent=p?.name||'';
    incomeEl.textContent=money(p?.income??0);
    expenseEl.textContent=money(p?.expense??0);
    balanceEl.textContent=money(p?.balance??0);

    ledgerEl.innerHTML='';
    if(p){
      p.ledger.slice().reverse().forEach(item=>{
        const li=document.createElement('li');
        li.textContent=`${item.time}ï½œ${p.name}ï½œğŸ²${item.roll}ï½œ${item.title}ï¼š${item.type==='income'?'+':'-'}${money(item.amount)}ï½œé¤˜é¡ ${money(item.balance)}`;
        li.style.color=item.type==='income'?'var(--good)':'var(--bad)';
        ledgerEl.appendChild(li);
      });
    }
    leaderboardEl.innerHTML='';
    [...players].sort((a,b)=>b.balance-a.balance).forEach(pp=>{
      const li=document.createElement('li'); li.textContent=`${pp.name}ï¼š${money(pp.balance)}`; leaderboardEl.appendChild(li);
    });
    roundNowEl.textContent=roundNow; roundMaxEl.textContent=roundMax;
    renderBoard();
  }

  // ========== è¨˜å¸³èˆ‡äº‹ä»¶ ==========
  function pushLedger(p, roll, title, delta){
    const entry={ time:new Date().toLocaleString(), player:p.name, roll, title, type: delta>=0?'income':'expense', amount:Math.abs(delta), balance:p.balance };
    p.ledger.push(entry); allLedger.push(entry);
  }

  function applyTileEffect(p, roll){
    const tile=TILES[p.pos||0]; buyBtn.style.display='none'; buyBtn.onclick=null;
    let title=''; let text=''; let delta=0;
    const cfg=readConfig();

    switch(tile.type){
      case 'start':
        title='èµ·é»'; text='å›åˆ°èµ·é»ï¼Œæ·±å‘¼å¸æº–å‚™å‡ºç™¼ã€‚'; delta=0; break;

      case 'salary': {
        const amt=tile.amount ?? randInt(cfg.salary[0], cfg.salary[1]);
        title=tile.name; text='é ˜åˆ°é›¶ç”¨é‡‘/ç´…åˆ©ï¼'; delta=+amt; p.income+=amt; p.balance+=amt; break; }

      case 'tax': {
        const amt=tile.amount ?? randInt(cfg.tax[0], cfg.tax[1]);
        title=tile.name; text='ç¹³äº¤ç¨…é‡‘ã€‚'; delta=-amt; p.expense+=amt; p.balance-=amt; break; }

      case 'donate': {
        const amt=tile.amount ?? randInt(cfg.donate[0], cfg.donate[1]);
        title=tile.name; text='åšå…¬ç›Šææ¬¾ï¼Œå¹«åŠ©éœ€è¦çš„äººã€‚'; delta=-amt; p.expense+=amt; p.balance-=amt; break; }

      case 'shop': {
        const cost=randInt(cfg.shop[0], cfg.shop[1]);
        title='è³¼ç‰©èŠ±è²»'; text='åœ¨å•†åº—è²·äº†éœ€è¦çš„æ±è¥¿ã€‚'; delta=-cost; p.expense+=cost; p.balance-=cost; break; }

      case 'stock': {
        const change=randInt(cfg.stock[0], cfg.stock[1]);
        title= change>=0 ? 'è‚¡ç¥¨ä¸Šæ¼²' : 'è‚¡ç¥¨ä¸‹è·Œ';
        text = change>=0 ? 'æŠ•è³‡æœ‰æˆï¼' : 'å¸‚å ´éœ‡ç›ªâ€¦';
        delta = change;
        if(change>=0){p.income+=change;p.balance+=change;}else{p.expense+=-change;p.balance+=change;}
        break; }

      case 'property': {
        const owner=tile.ownerIndex; const price=tile.price; const rent=tile.rent; const me=currentIndex;
        if(owner==null){
          title=tile.name; text=`ç„¡äººæ“æœ‰ï¼Œå¯è³¼è²·ï¼ˆåƒ¹æ ¼ $${money(price)}ï¼Œç§Ÿé‡‘ $${money(rent)}ï¼‰ã€‚`;
          delta=0;
          buyBtn.style.display='inline-block';
          buyBtn.textContent=`è³¼è²·ï¼ˆ$${money(price)}ï¼‰`;
          buyBtn.onclick=()=>{
            if(cfg.needCash && p.balance < price){ alert('ç¾é‡‘ä¸è¶³ï¼Œç„¡æ³•è³¼è²·ã€‚'); return; }
            p.expense+=price; p.balance-=price; pushLedger(p, roll, `è³¼è²· ${tile.name}`, -price);
            tile.ownerIndex=me; renderStats();
            cardTextEl.textContent=`å·²è³¼è²· ${tile.name}ï¼ç§Ÿé‡‘ $${money(rent)}ï¼ˆä»–äººåœç•™éœ€æ”¯ä»˜ï¼‰ã€‚`;
            cardAmountEl.textContent='æ”¯å‡º -'+money(price); cardAmountEl.style.color='var(--bad)'; buyBtn.style.display='none';
          };
        } else if(owner!==me){
          title=tile.name; text=`æ­¤åœ°ç”¢å±¬æ–¼ ${players[owner].name}ï¼Œéœ€æ”¯ä»˜ç§Ÿé‡‘ $${money(rent)}ã€‚`;
          delta=-rent; p.expense+=rent; p.balance-=rent; players[owner].income+=rent; players[owner].balance+=rent;
        } else {
          title=tile.name; text='ä½ æ“æœ‰é€™å€‹åœ°ç”¢ï¼Œå…è²»ä¼‘æ¯ã€‚'; delta=0;
        }
        break;
      }

      case 'event': default: {
        const ev=EVENTS[Math.floor(Math.random()*EVENTS.length)];
        title=ev.title; text=ev.text; delta= ev.type==='income'? ev.amount : -ev.amount;
        if(ev.type==='income'){p.income+=ev.amount;p.balance+=ev.amount;}else{p.expense+=ev.amount;p.balance-=ev.amount;}
        break; }
    }

    // é¡¯ç¤ºå¡ç‰‡
    cardTitleEl.textContent=title;
    cardTextEl.textContent=text;
    cardAmountEl.textContent=(delta>=0?'æ”¶å…¥ +':'æ”¯å‡º ')+money(Math.abs(delta));
    cardAmountEl.style.color=delta>=0?'var(--good)':'var(--bad)';
    const avatarSrc = p.img || svgAnimal('ğŸ™‚','#ddd');
    cardAvatarEl.src = avatarSrc;
    characterNameEl.textContent=p.name;
    cardEl.style.display='block';

    // è¨˜å¸³
    pushLedger(p, roll, title, delta);
  }

  // ========== éŠæˆ²æµç¨‹ ==========
  function startGame({reseed=false}={}){
    if(players.length<1){ alert('è«‹è‡³å°‘åŠ å…¥ 1 ä½ç©å®¶'); return; }
    roundMax = clamp(parseInt(roundLimitInput.value||'20',10),1,50);
    winTarget = Math.max(0, parseInt(winTargetInput.value||'5000',10));
    roundNow=1; currentIndex=0; gameOver=false; allLedger.length=0;

    const mode=layoutModeSel.value; const seed=seedInput.value.trim();
    if(reseed || !TILES || TILES.length!==PATH.length){ TILES = buildTiles(PATH.length, mode, seed); }
    else if(mode==='fixed'){ TILES = buildTiles(PATH.length, mode, seed); }

    document.getElementById('setup').style.display='block';
    gameEl.style.display='block';
    players = players.map(p=>({ ...p, pos:0, income:0, expense:0, balance:0, ledger:[] }));
    renderStats();
  }

  function advanceTurn(){
    cardEl.style.display='none'; if(!players.length || gameOver) return;
    currentIndex = (currentIndex + 1) % players.length;
    if(currentIndex===0){
      roundNow+=1;
      if(roundNow>roundMax){
        const top=[...players].sort((a,b)=>b.balance-a.balance)[0];
        alert(`â±ï¸ é”åˆ° ${roundMax} å›åˆï¼Œ${top.name} ä»¥ ${money(top.balance)} å…ƒç²å‹ï¼`);
        gameOver=true; return;
      }
    }
    renderStats(); resultEl.textContent='';
  }

  // æ“²éª°
  diceEl.addEventListener('click',()=>{
    if(gameOver){ return; }
    if(!players.length){ alert('è«‹å…ˆåŠ å…¥ç©å®¶'); return; }
    const p=players[currentIndex];
    const roll=Math.floor(Math.random()*6)+1;
    resultEl.textContent=`ä½ æ“²å‡ºäº†ï¼š${roll}`;
    p.pos = ((p.pos||0)+roll) % PATH.length;
    renderBoard();
    applyTileEffect(p, roll);
    if(winTarget>0 && p.balance>=winTarget){ alert(`ğŸ‰ æ­å–œ ${p.name} é”åˆ° ${money(winTarget)} å…ƒï¼Œç²å‹ï¼`); gameOver=true; }
  });

  okBtn.addEventListener('click', advanceTurn);
  nextBtn.addEventListener('click', advanceTurn);

  // ä¸‹è¼‰ CSVï¼ˆå…¨é«”ï¼‰
  function toCSV(rows){
    const esc=v=>'"'+String(v).replaceAll('"','""')+'"';
    const header=['æ™‚é–“','ç©å®¶','éª°å­','äº‹ä»¶','å‹åˆ¥','é‡‘é¡','çµé¤˜'];
    return [header.map(esc).join(',')]
      .concat(rows.map(r=>[r.time,r.player,r.roll,r.title,r.type,r.amount,r.balance].map(esc).join(',')))
      .join('\n');
  }
  downloadBtn.addEventListener('click',()=>{
    if(!allLedger.length){ alert('ç›®å‰æ²’æœ‰å¯ä¸‹è¼‰çš„æ”¶æ”¯ç´€éŒ„ã€‚'); return; }
    const blob=new Blob([toCSV(allLedger)],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`ç†è²¡å°å¯Œç¿_æ”¶æ”¯æ˜ç´°_${Date.now()}.csv`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // æ–°å±€
  quickNewBtn.addEventListener('click',()=>startGame({reseed:false}));
  reseedNewBtn.addEventListener('click',()=>startGame({reseed:true}));
  startBtn.addEventListener('click',()=>startGame({reseed:true}));

  // åˆå§‹ avatar
  buildAvatars();

  // ===== æ¸¬è©¦ï¼šç¶²å€åŠ  #test å¯è·‘åŸºæœ¬æª¢æŸ¥ =====
  function logTest(msg){ testOutput.style.display='block'; testOutput.textContent += msg + '\n'; }
  function runTests(){
    try{
      logTest('é–‹å§‹æ¸¬è©¦â€¦');
      console.assert(PATH.length===64,'PATH æ‡‰ç‚º 64');
      const uniq=new Set(PATH);
      console.assert(uniq.size===64,'PATH ä¸å¯é‡è¤‡');
      TILES = buildTiles(PATH.length,'fixed','TEST');
      console.assert(TILES.length===64,'TILES é•·åº¦æ­£ç¢º');
      console.assert(TILES[0].type==='start','ç¬¬ä¸€æ ¼æ‡‰ç‚ºèµ·é»');
      players=[ { ...CHARACTERS[0], name:'å°æ˜', pos:0, income:0, expense:0, balance:0, ledger:[] }, { ...CHARACTERS[1], name:'å°è¯', pos:0, income:0, expense:0, balance:0, ledger:[] } ];
      startGame({reseed:false});
      const before=players[0].ledger.length; diceEl.click();
      const after=players[0].ledger.length; console.assert(after===before+1,'æ“²éª°å¾Œæ‡‰è¨˜ä¸€ç­†');
      nextBtn.click(); console.assert(currentPlayerNameEl.textContent==='å°è¯','æ‡‰åˆ‡æ›åˆ°å°è¯');
      logTest('å…¨éƒ¨æ¸¬è©¦é€šé');
    }catch(e){ logTest('âŒ æ¸¬è©¦å¤±æ•—ï¼š'+(e?.message||e)); console.error(e); }
  }
  if(location.hash==='#test'){ runTests(); }
});
</script>
</body>
</html>
