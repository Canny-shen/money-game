<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>理財小富翁（動物版·進階）— 銀行/貸款/股利/新聞/停牌/投資事件</title>
<style>
  :root{
    --primary:#5d9cec; --panel:#ffffff; --bg:#f0f8ff; --ink:#0f172a;
    --accent:#8fb3ff; --good:#2e7d32; --bad:#c62828;
  }
  *{box-sizing:border-box}
  body{font-family:"Noto Sans TC",Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0;padding:12px}
  .layout{display:flex; gap:16px; align-items:flex-start; justify-content:center; max-width:1400px; margin:0 auto;}
  .leftCol{flex:0 0 560px; display:flex; flex-direction:column; gap:12px}
  .rightCol{flex:0 1 auto}
  .panel{background:var(--panel); border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.12); padding:12px;}
  h1{margin:0 0 12px; text-align:center}
  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  input,select{padding:6px;border-radius:8px;border:1px solid #cbd5e1}
  input[type=number]{width:120px}
  button{padding:8px 12px;border:0;border-radius:10px;background:var(--primary);color:#fff;font-size:14px;cursor:pointer}
  button.secondary{background:#e2e8f0;color:#111}
  button.danger{background:#ef4444}

  /* 頭像卡 */
  #avatars{display:flex;flex-wrap:wrap;gap:10px}
  .avatar{position:relative;width:150px;border:2px solid #ccc;border-radius:12px;background:#fff8dc;cursor:pointer;padding:6px;display:flex;flex-direction:column;align-items:center;gap:6px;transition:transform .15s,border-color .2s}
  .avatar:hover{transform:translateY(-2px);border-color:var(--primary)}
  .avatar .imgWrap{position:relative;width:100%}
  .avatar img{width:100%;height:auto;object-fit:contain;border-radius:10px}
  .avatar span{font-size:14px;font-weight:700}
  .avatar .pickedName{position:absolute;left:6px;right:6px;bottom:6px;background:rgba(0,0,0,.6);color:#fff;font-weight:700;font-size:14px;padding:4px 6px;border-radius:8px;text-align:center;display:none}
  .avatar.selected{border-color:var(--primary);box-shadow:0 0 0 3px rgba(93,156,236,.25) inset}
  .avatar.selected .pickedName{display:block}
  .avatar:disabled{opacity:.6;cursor:not-allowed}

  /* 資訊列 */
  .stats{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0}
  .chip{background:#fff;border-radius:999px;padding:6px 10px;box-shadow:0 2px 8px rgba(0,0,0,.07);font-size:13px}
  .good{color:var(--good)} .bad{color:var(--bad)}

  /* 骰子與卡 */
  #dice{font-size:72px;cursor:pointer;user-select:none;margin-top:6px;text-align:center}
  #result{margin-top:6px;font-size:18px;font-weight:700;text-align:center}
  #card{display:none;border:2px solid var(--accent);padding:12px;margin:10px 0 0;border-radius:14px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.12)}
  #card h3{margin:4px 0 6px}
  #card .amount{font-weight:700}

  /* 棋盤 */
  .boardWrap{position:sticky; top:8px}
  .boardTitle{margin:0 0 8px}
  .board{display:grid; grid-template-columns:repeat(8, 70px); grid-template-rows:repeat(8, 70px); gap:4px; background:#dbeafe; padding:6px; border-radius:12px;}
  .cell{background:#eaf4ff;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#333}
  .tile{background:#fff;border:2px solid var(--accent);border-radius:10px;padding:3px;width:100%;height:100%;display:flex;flex-direction:column;justify-content:space-between}
  .tile h4{margin:0 2px 2px;font-size:11px;line-height:1.15}
  .pills{display:flex;flex-wrap:wrap;gap:2px;padding:2px 2px 0}
  .pill{display:inline-flex;flex-direction:column;align-items:center;font-size:9px;background:#eef3ff;border:1px solid #c7d8ff;border-radius:6px;padding:1px 3px}
  .pill .nm{font-size:9px;line-height:1;margin-top:1px;color:#111}
  #tileInfo{margin-top:6px;font-size:14px}

  /* 股票持股表 */
  #holdings{width:100%; overflow:auto; border-top:1px dashed #cbd5e1; margin-top:8px; padding-top:8px}
  #holdings table{width:100%; border-collapse:collapse; font-size:12px}
  #holdings th,#holdings td{border-bottom:1px solid #eef2f7; padding:6px 4px; text-align:right}
  #holdings th:first-child,#holdings td:first-child{text-align:left}
  .pl{color:var(--good)} .mn{color:var(--bad)}

  details{margin-top:8px}
  summary{cursor:pointer}

  @media (max-width: 1060px){
    .layout{flex-direction:column}
    .leftCol,.rightCol{width:100%}
    .board{grid-template-columns:repeat(8, 52px); grid-template-rows:repeat(8, 52px)}
  }

  /* 小提示 */
  .muted{color:#64748b}
  .note{font-size:12px;color:#475569}
</style>
</head>
<body>
  <h1>🎲 理財小富翁（動物版·進階）</h1>

  <div class="layout">
    <div class="leftCol">
      <div class="panel" id="setup">
        <h3>玩家與規則</h3>
        <div class="row">
          <input id="nameInput" placeholder="請輸入玩家名稱"/>
          <div>初始金額：<input id="startMoney" type="number" min="0" step="100" value="3000" style="width:120px"></div>
          <div>回合上限：<input type="number" id="roundLimit" min="1" max="100" value="100" style="width:90px"></div>
          <div>勝利淨值（0=關閉）：<input type="number" id="winTarget" min="0" step="100" value="0" style="width:120px"></div>
        </div>
        <p style="margin:6px 0">點下方動物加入（最多 8 人）：</p>
        <div id="avatars"></div>
        <div class="row" style="margin-top:8px">
          <button id="startGame">開始遊戲</button>
          <button id="quickNew" class="secondary">新局（保留玩家，不變更棋盤）</button>
          <button id="reseedNew" class="secondary">新局＋重抽棋盤</button>
        </div>
        <p class="note">提示：每繞一圈會自動開啟「銀行存提」與處理利息、貸款扣款、股利、新聞事件。</p>
      </div>

      <div class="panel" id="game" style="display:none">
        <h3>目前玩家： <span id="currentPlayerName"></span></h3>
        <div class="row">
          <span>回合：<span id="roundNow">1</span>/<span id="roundMax">100</span></span>
          <span class="muted">（停牌股票禁止交易；受傷跳過一回合）</span>
        </div>

        <div class="stats">
          <div class="chip good">總收入：<span id="income">0</span></div>
          <div class="chip bad">總支出：<span id="expense">0</span></div>
          <div class="chip">現金：<strong id="balance">0</strong></div>
          <div class="chip">存款：<strong id="deposit">0</strong></div>
          <div class="chip">淨值：<strong id="networth">0</strong></div>
          <div class="chip">貸款餘額：<strong id="loanRemain">0</strong></div>
          <div class="chip">股票摘要：<strong id="stockSummary">—</strong></div>
        </div>

        <div id="dice" title="點我擲骰">🎲</div>
        <div id="result"></div>

        <div id="card">
          <div class="row">
            <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
              <img id="cardAvatar" alt="角色" style="width:72px;height:72px;border-radius:12px;object-fit:cover"/>
              <div id="characterName" style="font-weight:600"></div>
            </div>
            <div style="flex:1;min-width:280px">
              <h3 id="cardTitle">事件卡</h3>
              <p id="cardText">內容會在這裡出現</p>
              <p class="amount" id="cardAmount"></p>

              <!-- 股票操作列 -->
              <div id="stockActions" class="row" style="display:none">
                <div>📈 標的：
                  <select id="stockSelect"></select>
                </div>
                <div>市價：<b id="stockPrice"></b></div>
                <div>數量：<input id="stockQty" type="number" min="1" value="1" style="width:80px"></div>
                <button id="btnBuy">買入</button>
                <button id="btnSell" class="secondary">賣出</button>
              </div>

              <!-- 銀行操作列（每圈彈出） -->
              <div id="bankActions" class="row" style="display:none;margin-top:6px">
                <div>🏦 存款（年利 1.5%）：可 <b>存入/提領</b></div>
                <div>金額：<input id="bankAmount" type="number" min="0" value="0" style="width:120px"></div>
                <button id="btnDeposit" class="secondary">存入</button>
                <button id="btnWithdraw" class="secondary">提領</button>
              </div>

              <!-- 持股表 -->
              <div id="holdings" style="display:none"></div>

              <div class="row" style="margin-top:6px">
                <button id="buyBtn" class="secondary" style="display:none">購買/升級地產</button>
                <button id="okBtn">知道了</button>
                <button id="nextBtn" class="secondary">下一位</button>
              </div>
            </div>
          </div>
        </div>

        <details>
          <summary>📒 收支明細（目前玩家）</summary>
          <ul id="ledger" style="text-align:left;max-height:240px;overflow:auto;margin:8px 0 0"></ul>
        </details>

        <details>
          <summary>📊 排行（淨值：現金+存款+地產+股票−貸款）</summary>
          <ol id="leaderboard" style="text-align:left;margin:8px 0 0"></ol>
        </details>
      </div>
    </div>

    <div class="rightCol">
      <div class="panel boardWrap">
        <h3 class="boardTitle">8×8 螺旋棋盤（外框→向內）</h3>
        <div id="board" class="board" aria-live="polite"></div>
        <div id="tileInfo">位置：—</div>
      </div>
    </div>
  </div>

  <div id="testOutput" style="display:none;white-space:pre-wrap;background:#fff;border:1px dashed #bbb;padding:8px;max-width:1200px;margin:10px auto"></div>

<script>
addEventListener('DOMContentLoaded', () => {
  // ========= 小工具 =========
  const $ = id => document.getElementById(id);
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const money = n => Number(Math.round(Number(n)||0)).toLocaleString('zh-TW');
  const randInt=(min,max,rnd=Math.random)=>Math.floor(min + rnd()*(max-min+1));
  const nowStr = ()=> new Date().toLocaleString();

  // 角色圖：內嵌 SVG
  function svgAnimal(emoji, bg){
    const svg = `<?xml version='1.0' encoding='UTF-8'?>
      <svg xmlns='http://www.w3.org/2000/svg' width='400' height='400'>
        <rect width='100%' height='100%' rx='40' ry='40' fill='${bg}'/>
        <circle cx='200' cy='150' r='120' fill='rgba(255,255,255,0.85)' />
        <text x='50%' y='58%' dominant-baseline='middle' text-anchor='middle' font-size='160'>${emoji}</text>
      </svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  }
  const CHARACTERS = [
    { name: '小熊',   emoji:'🐻', bg:'#FFD166' },
    { name: '小兔',   emoji:'🐰', bg:'#EF476F' },
    { name: '小狗',   emoji:'🐶', bg:'#06D6A0' },
    { name: '小貓',   emoji:'🐱', bg:'#118AB2' },
    { name: '小象',   emoji:'🐘', bg:'#8ECAE6' },
    { name: '小狐狸', emoji:'🦊', bg:'#FFB703' },
    { name: '小鳥',   emoji:'🐦', bg:'#A3D9A5' },
    { name: '小企鵝', emoji:'🐧', bg:'#CBD5E1' }
  ].map(c => ({ ...c, img: svgAnimal(c.emoji, c.bg) }));

  // ========= DOM =========
  const nameInput=$('nameInput');
  const startMoneyInput=$('startMoney');
  const roundLimitInput=$('roundLimit');
  const winTargetInput=$('winTarget');

  const avatarsEl=$('avatars');
  const startBtn=$('startGame');
  const quickNewBtn=$('quickNew');
  const reseedNewBtn=$('reseedNew');

  const gameEl=$('game');
  const setupEl=$('setup');
  const leftCol=document.querySelector('.leftCol');

  const currentPlayerNameEl=$('currentPlayerName');
  const roundNowEl=$('roundNow');
  const roundMaxEl=$('roundMax');
  const incomeEl=$('income');
  const expenseEl=$('expense');
  const balanceEl=$('balance');
  const depositEl=$('deposit');
  const networthEl=$('networth');
  const loanRemainEl=$('loanRemain');
  const stockSummaryEl=$('stockSummary');

  const diceEl=$('dice');
  const resultEl=$('result');
  const cardEl=$('card');
  const cardAvatarEl=$('cardAvatar');
  const characterNameEl=$('characterName');
  const cardTitleEl=$('cardTitle');
  const cardTextEl=$('cardText');
  const cardAmountEl=$('cardAmount');

  const stockActionsEl=$('stockActions');
  const stockPriceEl=$('stockPrice');
  const stockQtyEl=$('stockQty');
  const stockSelectEl=$('stockSelect');
  const btnBuy=$('btnBuy');
  const btnSell=$('btnSell');
  const holdingsEl=$('holdings');

  const bankActionsEl=$('bankActions');
  const bankAmountEl=$('bankAmount');
  const btnDeposit=$('btnDeposit');
  const btnWithdraw=$('btnWithdraw');

  const buyBtn=$('buyBtn');
  const okBtn=$('okBtn');
  const nextBtn=$('nextBtn');

  const boardEl=$('board');
  const tileInfoEl=$('tileInfo');
  const ledgerEl=$('ledger');
  const leaderboardEl=$('leaderboard');
  const testOutput=$('testOutput');

  // ========= 狀態 =========
  let players=[]; let currentIndex=0; let gameOver=false;
  let roundNow=1; let roundMax=100; let winTarget=0;
  const allLedger=[];
  const GRID=8;
  let marketTimer=null;

  // === 市場/股票 ===
  const MONTHS_PER_YEAR = 12; // 每圈≈每月
  const MARKET={
    list: [
      {symbol:'LION', name:'雄獅', yield:0.025},
      {symbol:'BEAR', name:'棕熊', yield:0.020},
      {symbol:'FOX',  name:'狐狸', yield:0.018},
      {symbol:'CAT',  name:'小貓', yield:0.022},
      {symbol:'DOG',  name:'小狗', yield:0.021},
      {symbol:'RABT', name:'小兔', yield:0.017},
      {symbol:'TIGR', name:'老虎', yield:0.019},
      {symbol:'PAND', name:'熊貓', yield:0.023},
      {symbol:'DEER', name:'梅花鹿', yield:0.016},
      {symbol:'WOLF', name:'灰狼', yield:0.020},
      {symbol:'EAGL', name:'老鷹', yield:0.024},
      {symbol:'OWLS', name:'貓頭鷹', yield:0.018},
      {symbol:'DOLP', name:'海豚', yield:0.022},
      {symbol:'SEAL', name:'海豹', yield:0.019},
      {symbol:'PENG', name:'企鵝', yield:0.021},
      {symbol:'KOAL', name:'無尾熊', yield:0.02},
      {symbol:'SLOV', name:'樹懶', yield:0.017},
      {symbol:'MICE', name:'小鼠', yield:0.016},
      {symbol:'HORS', name:'駿馬', yield:0.02},
      {symbol:'ZEBR', name:'斑馬', yield:0.018}
    ],
    price: {},
    news: {}, // {sym:{halt:n, bias:0.0}}
    init(){
      this.list.forEach((s,i)=>{
        this.price[s.symbol] = 60 + Math.round((i+1)* (240/this.list.length)) + Math.floor(Math.random()*20);
        this.news[s.symbol]  = { halt:0, bias:0, biasTurns:0 };
      });
    },
    tickAll(){
      for(const s of this.list){
        const sym=s.symbol;
        const info=this.news[sym]||{halt:0,bias:0,biasTurns:0};
        if(info.halt>0){
          info.halt -= 1; // 停牌倒數
          this.news[sym]=info;
          continue; // 停牌不變動
        }
        const p=this.price[sym];
        // 基礎波動 -10% ~ +10%
        let pct=(Math.random()*0.20)-0.10;
        // 新聞偏移（暫時性）
        if(info.biasTurns>0){
          pct += info.bias;
          info.biasTurns -= 1;
          this.news[sym]=info;
        }
        // 限制每次 ±10%
        pct = Math.max(-0.10, Math.min(0.10, pct));
        let np = Math.round(Math.max(10, p*(1+pct)));
        this.price[sym]=np;
      }
    },
    randomNews(){
      // 機率觸發一檔新聞：利多/利空/停牌（約 30% 機會觸發）
      if(Math.random() < 0.30){
        const pick = this.list[Math.floor(Math.random()*this.list.length)];
        const sym = pick.symbol;
        const roll = Math.random();
        if(roll < 0.33){
          // 停牌 1~3 期
          this.news[sym].halt = randInt(1,3);
          return { type:'halt', sym, text:`${sym} 因重大訊息暫停交易 ${this.news[sym].halt} 期。` };
        }else{
          // 偏移：利多(+3%基準) 或 利空(-3%基準)，持續 3 期
          const isGood = roll < 0.66;
          this.news[sym].bias = isGood ? +0.03 : -0.03;
          this.news[sym].biasTurns = 3;
          return { type: isGood?'good':'bad', sym, text:`${sym} 新聞${isGood?'利多':'利空'}，短期波動傾向 ${isGood?'+':'-'}。` };
        }
      }
      return null;
    }
  };
  MARKET.init();

  // 8×8 螺旋路徑
  function spiralPath(n){
    const res=[]; let top=0,bottom=n-1,left=0,right=n-1;
    while(left<=right && top<=bottom){
      for(let c=left;c<=right;c++) res.push(top*n+c);
      for(let r=top+1;r<=bottom;r++) res.push(r*n+right);
      if(top<bottom){ for(let c=right-1;c>=left;c--) res.push(bottom*n+c); }
      if(left<right){ for(let r=bottom-1;r>top;r--) res.push(r*n+left); }
      top++; right--; bottom--; left++;
    }
    return res;
  }
  const PATH=spiralPath(GRID);

  // 事件卡池（新增：住院、投資事件）
  const EVENTS=[
    { title:'打工賺錢', text:'你去便利商店打工。', type:'income', amount:200 },
    { title:'壓歲錢', text:'收到阿嬤的紅包。', type:'income', amount:500 },
    { title:'投稿得獎', text:'畫畫投稿獲得獎金。', type:'income', amount:300 },
    { title:'回收瓶罐', text:'做環保也能賺零用錢。', type:'income', amount:120 },
    { title:'手機維修', text:'手機壞了，付維修費。', type:'expense', amount:300 },
    { title:'遊樂園', text:'和朋友出遊，門票餐飲。', type:'expense', amount:400 },
    { title:'文具補給', text:'買筆記本與鉛筆。', type:'expense', amount:80 },
    { title:'同學生日禮', text:'挑小禮物慶生。', type:'expense', amount:150 },
    { title:'社團表現優秀', text:'被老師表揚，得到小獎金。', type:'income', amount:250 },
    { title:'遺失車票', text:'補買車票。', type:'expense', amount:60 },
    // 進階
    { title:'受傷住院', text:'不小心受傷住院，休息一回合。', type:'skip', skip:1 },
    { title:'投資提案', text:'社團學長提供一個投資提案，要不要參與？（下次輪到你自動結算盈虧）', type:'invest_offer' }
  ];

  // 建盤：含地產
  function buildTiles(len){
    const tiles=[{ name:'起點', type:'start' }];
    let propId=1;
    const weights={ salary:0.20, event:0.28, shop:0.10, stock:0.14, tax:0.08, donate:0.04, property:0.16 };
    const keys=Object.keys(weights);
    const pick=()=>{ let r=Math.random(); let acc=0; for(const k of keys){ acc+=weights[k]; if(r<=acc) return k; } return keys.at(-1); };
    for(let i=1;i<len;i++){
      const t=pick();
      if(t==='salary')       tiles.push({ name:Math.random()<0.5?'零用金':'紅利', type:'salary', amount: randInt(180,420) });
      else if(t==='event')   tiles.push({ name:'事件', type:'event' });
      else if(t==='shop')    tiles.push({ name:'商店', type:'shop', min:60, max:260 });
      else if(t==='stock')   tiles.push({ name:'股票', type:'stock' });
      else if(t==='tax')     tiles.push({ name:'稅金', type:'tax',  amount: randInt(80,180) });
      else if(t==='donate')  tiles.push({ name:'捐款', type:'donate',amount: randInt(60,140) });
      else if(t==='property'){
        const price=randInt(800,1600);
        const baseRent=Math.max(10, Math.floor(price*0.18));
        tiles.push({ name:`地產 ${propId++}`, type:'property', price, baseRent, level:1, maxLevel:3, ownerIndex:null });
      }
    }
    return tiles;
  }
  let TILES=buildTiles(PATH.length);

  // === 貸款工具 ===
  function pmts(P, annualRate, months){
    const r = annualRate / MONTHS_PER_YEAR;
    if(r===0) return P / months;
    return P * r / (1 - Math.pow(1+r, -months));
  }
  function loanOutstanding(loans=[]){
    return loans.reduce((acc,x)=> acc + (x.remainingPrincipal||0), 0);
  }

  // === 幫助計算：地產 / 股票 / 淨值 / 存款 ===
  function propertyValueForPlayer(playerIndex){
    let total=0;
    TILES.forEach(t=>{
      if(t.type==='property' && t.ownerIndex===playerIndex){
        total += (t.price||0) * (t.level||1);
      }
    });
    return total;
  }
  function stockValueOf(player){
    let total=0; if(!player?.stocks) return 0;
    for(const sym in player.stocks){
      const {qty=0}=player.stocks[sym]||{};
      const px = MARKET.price[sym]||0;
      total += qty * px;
    }
    return total;
  }
  function netWorthOf(player, playerIndex){
    const props = propertyValueForPlayer(playerIndex);
    const stocks = stockValueOf(player);
    const loans  = loanOutstanding(player.loans||[]);
    return (player.balance||0) + (player.bankDeposit||0) + props + stocks - loans;
  }

  // === UI：角色頭像 ===
  function buildAvatars(){
    avatarsEl.innerHTML='';
    CHARACTERS.forEach(c=>{
      const div=document.createElement('button');
      div.type='button'; div.className='avatar';
      const imgWrap=document.createElement('div'); imgWrap.className='imgWrap'; div.appendChild(imgWrap);

      const visual=document.createElement('div'); visual.style.fontSize='64px'; visual.style.lineHeight='1'; visual.textContent=c.emoji; imgWrap.appendChild(visual);
      const img=new Image(); img.alt=c.name; img.onload=()=>visual.replaceWith(img); img.src=c.img;

      const picked=document.createElement('div'); picked.className='pickedName'; picked.textContent=''; imgWrap.appendChild(picked);
      const label=document.createElement('span'); label.textContent=c.name; div.appendChild(label);

      div.addEventListener('click',()=>{
        const customName=nameInput?.value.trim();
        if(!customName){ alert('請先輸入名稱'); return; }
        if(players.length>=8){ alert('最多 8 位玩家'); return; }
        const stockBag={}; MARKET.list.forEach(s=>stockBag[s.symbol]={qty:0,avg:0});
        players.push({
          name:customName, img:(img.src||''), income:0, expense:0, balance:0, bankDeposit:0,
          ledger:[], pos:0, stocks: stockBag, loans:[], skipTurns:0, pendingInvestment:null
        });
        picked.textContent=customName;
        div.classList.add('selected'); div.disabled=true;
        nameInput.value='';
        renderBoard(); renderStats();
      });

      avatarsEl.appendChild(div);
    });
  }

  // === 棋盤繪製（含防呆） ===
  function renderBoard(){
    if(!boardEl){ console.error('找不到 #board'); return; }
    boardEl.innerHTML='';
    const total = GRID*GRID;
    for(let i=0;i<total;i++){
      const cell=document.createElement('div'); cell.className='cell'; cell.dataset.idx=i;
      boardEl.appendChild(cell);
    }
    if(!Array.isArray(PATH) || PATH.length!==total){
      boardEl.innerHTML = `<div style="padding:8px;color:#c62828;background:#fff;border-radius:8px">
        棋盤路徑產生失敗（PATH 長度=${PATH?.length||'N/A'}，應為 ${total}）。
      </div>`;
      return;
    }
    for(let k=0;k<TILES.length;k++){
      const boardIndex = PATH[k];
      const cell=boardEl.querySelector(`.cell[data-idx="${boardIndex}"]`);
      if(!cell){ continue; }
      const t=TILES[k];
      const tile=document.createElement('div'); tile.className='tile';

      let own = '';
      if(t.type==='property'){
        const lv = t.level || 1;
        own = (t.ownerIndex!=null) ? `<span style="float:right">🏠x${lv}</span>` : '<span style="float:right">🏠</span>';
      }
      let sub='';
      if(t.type==='property'){
        const rent = (t.baseRent||0) * (t.level||1);
        sub = `<small style="margin-left:6px">$ ${money(t.price)} / 租 $ ${money(rent)}</small>`;
      } else if(t.amount){
        sub = `<small style="margin-left:6px">$ ${money(t.amount)}</small>`;
      }
      tile.innerHTML=`<h4>${k+1}. ${t.name} ${own} ${sub}</h4><div class="pills" id="tile-${k}"></div>`;
      cell.innerHTML=''; cell.appendChild(tile);
    }

    // 玩家標記 + 名稱
    players.forEach((pl)=>{
      const wrap=document.getElementById('tile-'+(pl.pos||0));
      if(wrap){
        const pill=document.createElement('span'); pill.className='pill';
        const top = document.createElement('span'); top.textContent='●';
        const nm = document.createElement('span'); nm.className='nm'; nm.textContent=(pl.name||'P').slice(0,6);
        pill.appendChild(top); pill.appendChild(nm);
        wrap.appendChild(pill);
      }
    });

    const cp=players[currentIndex];
    if(cp){ const t=TILES[cp.pos||0]; tileInfoEl.textContent=`位置：第 ${(cp.pos||0)+1} 格（${t.name}）`; }
  }

  // === 統計 ===
  function renderStats(){
    const p=players[currentIndex];
    currentPlayerNameEl.textContent=p?.name||'';
    incomeEl.textContent=money(p?.income??0);
    expenseEl.textContent=money(p?.expense??0);
    balanceEl.textContent=money(p?.balance??0);
    depositEl.textContent=money(p?.bankDeposit??0);

    if(p){
      const pv = propertyValueForPlayer(currentIndex);
      const sv = stockValueOf(p);
      const loans = loanOutstanding(p.loans||[]);
      networthEl.textContent = money((p.balance||0) + (p.bankDeposit||0) + pv + sv - loans);
      loanRemainEl.textContent = money(loans);
      const held = Object.entries(p.stocks).filter(([sym,obj])=>(obj?.qty||0)>0).slice(0,4).map(([sym,obj])=>`${sym}:${obj.qty}`).join('，');
      stockSummaryEl.textContent = held || '—';
    }else{
      networthEl.textContent = '0';
      loanRemainEl.textContent = '0';
      stockSummaryEl.textContent = '—';
    }

    // 明細
    ledgerEl.innerHTML='';
    if(p){
      p.ledger.slice().reverse().forEach(item=>{
        const li=document.createElement('li');
        li.textContent=`${item.time}｜${p.name}｜${item.tag||''} ${item.title}：${item.delta>=0?'+':'-'}${money(Math.abs(item.amount||item.delta||0))}｜現金 ${money(item.balance)}｜存款 ${money(item.deposit||p.bankDeposit||0)}`;
        li.style.color=(item.delta??0)>=0?'var(--good)':'var(--bad)';
        ledgerEl.appendChild(li);
      });
    }
    // 排行（依資產淨值排序）
    leaderboardEl.innerHTML='';
    const ranked = players.map((pp,idx)=>{
      return { pp, idx, pv: propertyValueForPlayer(idx), sv: stockValueOf(pp), loans: loanOutstanding(pp.loans||[]) };
    }).map(r=>({ ...r, nw: (r.pp.balance||0)+(r.pp.bankDeposit||0)+r.pv+r.sv-r.loans }))
      .sort((a,b)=>b.nw-a.nw);
    ranked.forEach(r=>{
      const li=document.createElement('li'); 
      li.textContent=`${r.pp.name}：淨值 ${money(r.nw)}（現金 ${money(r.pp.balance)}｜存款 ${money(r.pp.bankDeposit)}｜地產 ${money(r.pv)}｜股票 ${money(r.sv)}｜貸款 ${money(r.loans)}）`;
      leaderboardEl.appendChild(li);
    });

    roundNowEl.textContent=roundNow; roundMaxEl.textContent=roundMax;
    renderBoard();
  }

  function pushLedger(p, opts){
    const entry = {
      time: nowStr(),
      player: p.name,
      title: opts.title||'',
      tag: opts.tag||'',
      delta: opts.delta||0,
      amount: opts.amount!=null ? opts.amount : Math.abs(opts.delta||0),
      balance: p.balance,
      deposit: p.bankDeposit
    };
    p.ledger.push(entry); allLedger.push(entry);
  }

  // === 股票：持股表 ===
  function renderHoldings(p, highlightSym=null){
    const rows = [];
    let any=false;
    for(const s of MARKET.list){
      const sym=s.symbol;
      const {qty=0, avg=0} = p.stocks[sym]||{};
      if(qty>0){
        any=true;
        const px = MARKET.price[sym]||0;
        const pl = (px-avg)*qty;
        const halted = (MARKET.news[sym]?.halt||0)>0 ? '（停牌）' : '';
        rows.push(
          `<tr${highlightSym===sym?' style="background:#f3f7ff"':''}>
            <td>${sym}${halted}</td>
            <td>${qty}</td>
            <td>$ ${money(avg)}</td>
            <td>$ ${money(px)}</td>
            <td class="${pl>=0?'pl':'mn'}">${pl>=0?'+':''}$ ${money(Math.abs(pl))}</td>
          </tr>`
        );
      }
    }
    holdingsEl.style.display='block';
    holdingsEl.innerHTML = any ? `
      <div style="font-weight:700;margin:6px 0 4px">我的持股</div>
      <table>
        <thead><tr><th>代號</th><th>數量</th><th>平均成本</th><th>現價</th><th>未實現損益</th></tr></thead>
        <tbody>${rows.join('')}</tbody>
      </table>
    ` : `<em style="color:#64748b">尚無持股</em>`;
  }

  // === 交易不足 -> 貸款輔助 ===
  const LOAN_RATES = { stock:0.055, property:0.035, upgrade:0.040 }; // 參考情境
  function askLoan(p, purpose, shortage){
    const term = parseInt(prompt(`現金不足，是否申請貸款補足 $${money(shortage)}？請輸入年限 1–5（取消=不貸）`, '3'), 10);
    if(!(term>=1 && term<=5)) return false;
    const rate = LOAN_RATES[purpose] || 0.05;
    const months = term * MONTHS_PER_YEAR;
    const pay = Math.round(pmts(shortage, rate, months));
    p.loans.push({
      purpose, termYears:term, annualRate:rate,
      remainingPeriods: months,
      paymentPerPeriod: pay,
      remainingPrincipal: shortage
    });
    p.income += shortage; // 視作貸入金額進帳
    p.balance += shortage;
    pushLedger(p, {title:`申貸（${purpose}）${term}年`, tag:'🧾', delta:+shortage});
    alert(`已核貸 $${money(shortage)}，等額本息每圈扣 $${money(pay)}，共 ${months} 期。`);
    return true;
  }

  // === 每圈處理：利息/貸款扣款/股利/新聞/銀行介面 ===
  const BANK_RATE = 0.015; // 年利 1.5%
  function processLap(p){
    // 存款利息（複利，存款本身增加）
    if(p.bankDeposit>0){
      const add = Math.round(p.bankDeposit * (BANK_RATE / MONTHS_PER_YEAR));
      p.bankDeposit += add;
      p.income += add;
      pushLedger(p, {title:'存款利息', tag:'💰', delta:+add});
    }

    // 貸款等額本息扣款
    if(p.loans?.length){
      p.loans.forEach(loan=>{
        if(loan.remainingPeriods>0){
          // 利息
          const r = loan.annualRate / MONTHS_PER_YEAR;
          const interest = Math.round(loan.remainingPrincipal * r);
          let principal = loan.paymentPerPeriod - interest;
          if(principal > loan.remainingPrincipal) principal = loan.remainingPrincipal;
          loan.remainingPrincipal -= principal;
          loan.remainingPeriods -= 1;

          const pay = principal + interest;
          p.expense += pay; p.balance -= pay;
          pushLedger(p, {title:`貸款扣款（${loan.purpose}）`, tag:'🧾', delta:-pay, amount:pay});

        }
      });
      // 清理已結清
      p.loans = p.loans.filter(l=>l.remainingPrincipal>0 && l.remainingPeriods>0);
    }

    // 股利發放
    let divTotal=0;
    for(const s of MARKET.list){
      const sym=s.symbol;
      const {qty=0} = p.stocks[sym]||{};
      if(qty>0){
        const px = MARKET.price[sym]||0;
        const div = Math.round(qty * px * (s.yield / MONTHS_PER_YEAR));
        if(div>0){ divTotal += div; }
      }
    }
    if(divTotal>0){
      p.income += divTotal; p.balance += divTotal;
      pushLedger(p, {title:'持股股利入帳', tag:'💹', delta:+divTotal});
    }

    // 新聞事件
    const news = MARKET.randomNews();
    if(news){
      pushLedger(p, {title:`市場新聞：${news.text}`, tag:'📰', delta:0});
      cardEl.style.display='block';
      cardTitleEl.textContent='市場新聞';
      cardTextEl.textContent=news.text;
      cardAmountEl.textContent='';
      stockActionsEl.style.display='none';
      bankActionsEl.style.display='flex';
    }

    // 自動開啟銀行介面（讓玩家立刻存/提）
    showBankUI(p);
  }

  function showBankUI(p){
    cardEl.style.display='block';
    cardTitleEl.textContent='🏦 銀行服務（每圈彈出）';
    cardTextEl.innerHTML = `你的存款：<b>$ ${money(p.bankDeposit)}</b>，可選擇存入或提領。`;
    cardAmountEl.textContent='';
    bankActionsEl.style.display='flex';
    stockActionsEl.style.display='none';
    buyBtn.style.display='none';
    cardAvatarEl.src = p.img || svgAnimal('🙂','#ddd');
    characterNameEl.textContent=p.name;

    btnDeposit.onclick=()=>{
      const amt = Math.max(0, parseInt(bankAmountEl.value||'0',10));
      if(amt<=0) return;
      if(p.balance < amt){ alert('現金不足'); return; }
      p.balance -= amt; p.bankDeposit += amt;
      pushLedger(p, {title:'銀行存入', tag:'🏦', delta:0, amount:amt});
      renderStats();
      cardTextEl.innerHTML = `已存入 $ ${money(amt)}。目前存款：<b>$ ${money(p.bankDeposit)}</b>`;
    };
    btnWithdraw.onclick=()=>{
      const amt = Math.max(0, parseInt(bankAmountEl.value||'0',10));
      if(amt<=0) return;
      if(p.bankDeposit < amt){ alert('存款不足'); return; }
      p.bankDeposit -= amt; p.balance += amt;
      pushLedger(p, {title:'銀行提領', tag:'🏦', delta:0, amount:amt});
      renderStats();
      cardTextEl.innerHTML = `已提領 $ ${money(amt)}。目前存款：<b>$ ${money(p.bankDeposit)}</b>`;
    };
  }

  // === 勝利（淨值）檢查（可選，winTarget>0 才啟用） ===
  function checkNetworthWin(p, pIndex){
    const nw = netWorthOf(p, pIndex);
    if(winTarget>0 && nw>=winTarget){
      alert(`🎉 恭喜 ${p.name} 資產淨值達到 $${money(winTarget)}，獲勝！`);
      gameOver=true;
      stopMarketTimer();
      return true;
    }
    return false;
  }

  // === 事件處理 ===
  function applyTileEffect(p, roll){
    const tile=TILES[p.pos||0];
    buyBtn.style.display='none'; buyBtn.onclick=null;
    stockActionsEl.style.display='none';
    bankActionsEl.style.display='none';
    holdingsEl.style.display='none';
    btnBuy.onclick=null; btnSell.onclick=null;

    let title=''; let text=''; let delta=0;

    switch(tile.type){
      case 'start':
        title='起點'; text='回到起點，深呼吸準備出發。'; delta=0; break;

      case 'salary': {
        const amt=tile.amount;
        title=tile.name; text='領到零用金/紅利！'; delta=+amt; p.income+=amt; p.balance+=amt; break; }

      case 'tax': {
        const amt=tile.amount;
        title=tile.name; text='繳交稅金。'; delta=-amt; p.expense+=amt; p.balance-=amt; break; }

      case 'donate': {
        const amt=tile.amount;
        title=tile.name; text='做公益捐款，幫助需要的人。'; delta=-amt; p.expense+=amt; p.balance-=amt; break; }

      case 'shop': {
        const cost=randInt(tile.min, tile.max);
        title='購物花費'; text='在商店買了需要的東西。'; delta=-cost; p.expense+=cost; p.balance-=cost; break; }

      case 'stock': {
        stockSelectEl.innerHTML='';
        MARKET.list.forEach(s=>{
          const opt=document.createElement('option');
          const halted = (MARKET.news[s.symbol]?.halt||0)>0 ? '（停牌）' : '';
          opt.value=s.symbol; opt.textContent=`${s.symbol}（${s.name}）${halted}`;
          stockSelectEl.appendChild(opt);
        });
        stockSelectEl.selectedIndex = Math.floor(Math.random()*MARKET.list.length);

        const updatePriceUI = () => {
          const sym = stockSelectEl.value;
          const px = MARKET.price[sym];
          const halted = (MARKET.news[sym]?.halt||0)>0;
          stockPriceEl.textContent = '$ ' + money(px) + (halted?'（停牌）':'');
          stockQtyEl.value = 1;
          cardTextEl.innerHTML = `推薦標的：<b>${sym}</b>（可改選），目前市價 $ ${money(px)}。${halted?' <span class="bad">停牌中，禁止交易。</span>':''}`;
          renderHoldings(p, sym);
          btnBuy.disabled = halted;
          btnSell.disabled = halted;
        };
        updatePriceUI();

        title=`股票：買賣`;
        delta=0;
        stockActionsEl.style.display='flex';
        stockSelectEl.onchange = updatePriceUI;

        // 買入（不足可貸）
        btnBuy.onclick=()=>{
          const sym = stockSelectEl.value;
          const qty = Math.max(1, parseInt(stockQtyEl.value||'1',10));
          const px = MARKET.price[sym];
          const cost = qty * px;
          if(p.balance < cost){
            const shortage = cost - p.balance;
            if(!askLoan(p,'stock',shortage)) return;
          }
          const cur = p.stocks[sym] || {qty:0,avg:0};
          const newQty = cur.qty + qty;
          const newAvg = newQty>0 ? Math.round(((cur.qty*cur.avg) + cost) / newQty) : 0;

          p.stocks[sym] = { qty:newQty, avg:newAvg };
          p.balance -= cost; p.expense += cost;

          pushLedger(p, {title:`買入 ${sym} ${qty} 股（$ ${money(px)}）`, tag:'📈', delta:-cost});
          renderStats();
          updatePriceUI();
          cardTextEl.textContent = `買入成功，${sym} 持有 ${newQty} 股，平均成本 $ ${money(newAvg)}。`;
          checkNetworthWin(p, currentIndex);
        };

        // 賣出
        btnSell.onclick=()=>{
          const sym = stockSelectEl.value;
          const qty = Math.max(1, parseInt(stockQtyEl.value||'1',10));
          const cur = p.stocks[sym] || {qty:0,avg:0};
          if(cur.qty < qty){ alert('持股不足。'); return; }
          const px = MARKET.price[sym];
          const proceeds = qty * px;
          const remainQty = cur.qty - qty;
          p.stocks[sym] = { qty: remainQty, avg: cur.avg };
          p.balance += proceeds; p.income += proceeds;

          pushLedger(p, {title:`賣出 ${sym} ${qty} 股（$ ${money(px)}）`, tag:'📉', delta:+proceeds});
          renderStats();
          updatePriceUI();
          cardTextEl.textContent = `賣出成功，${sym} 剩餘 ${remainQty} 股。`;
          checkNetworthWin(p, currentIndex);
        };
        break;
      }

      case 'property': {
        const me=currentIndex;
        const owner=tile.ownerIndex;
        const rent = (tile.baseRent||0) * (tile.level||1);
        const upgradeCost = Math.floor(tile.price * 0.6);

        if(owner==null){
          title=tile.name; text=`無人擁有，可購買（價格 $ ${money(tile.price)}，租金 $ ${money(rent)}）。`;
          delta=0;
          buyBtn.style.display='inline-block';
          buyBtn.textContent = `購買（$ ${money(tile.price)}）`;
          buyBtn.onclick=()=>{
            let price=tile.price;
            if(p.balance < price){
              const shortage = price - p.balance;
              if(!askLoan(p,'property',shortage)) return;
            }
            p.expense += price; p.balance -= price;
            pushLedger(p, {title:`購買 ${tile.name}`, tag:'🏡', delta:-price});
            tile.ownerIndex = me; renderStats();
            cardTextEl.textContent = `已購買 ${tile.name}！目前等級 Lv${tile.level}，租金 $ ${money(rent)}。`;
            buyBtn.style.display='none';
            checkNetworthWin(p, currentIndex);
          };
        } else if(owner!==me){
          title=tile.name; text=`此地產屬於 ${players[owner].name}，需支付租金 $ ${money(rent)}。`;
          delta=-rent; p.expense+=rent; p.balance-=rent; players[owner].income+=rent; players[owner].balance+=rent;
        } else {
          title=tile.name; text=`你擁有這個地產（Lv${tile.level}/${tile.maxLevel}），可選擇升級提高租金。`;
          delta=0;
          if(tile.level < tile.maxLevel){
            buyBtn.style.display='inline-block';
            buyBtn.textContent = `升級至 Lv${tile.level+1}（$ ${money(upgradeCost)}）`;
            buyBtn.onclick=()=>{
              let price=upgradeCost;
              if(p.balance < price){
                const shortage = price - p.balance;
                if(!askLoan(p,'upgrade',shortage)) return;
              }
              p.expense += price; p.balance -= price;
              tile.level += 1;
              pushLedger(p, {title:`${tile.name} 升級至 Lv${tile.level}`, tag:'🏗️', delta:-price});
              renderStats();
              const newRent = (tile.baseRent||0) * (tile.level||1);
              cardTextEl.textContent = `升級成功！新租金 $ ${money(newRent)}。`;
              if(tile.level>=tile.maxLevel) buyBtn.style.display='none';
              checkNetworthWin(p, currentIndex);
            };
          } else {
            buyBtn.style.display='none';
          }
        }
        break;
      }

      case 'event': default: {
        const ev=EVENTS[Math.floor(Math.random()*EVENTS.length)];
        if(ev.type==='skip'){
          title=ev.title; text=ev.text; delta=0; p.skipTurns = (p.skipTurns||0) + (ev.skip||1);
        } else if(ev.type==='invest_offer'){
          title=ev.title; 
          const cost = randInt(200,600);
          const expect = randInt(150,800) - 400; // 可能賺或賠
          text=`投資成本 $${money(cost)}，預期回報介於 ${expect>=0?'+':''}$${money(expect)} 左右。是否參與？（結果將在你下一回合自動結算）`;
          delta=0;
          // 提供立即操作：參與/不參與
          const join = confirm(`${text}\n\n按「確定」=參與；「取消」=不參與`);
          if(join){
            if(p.balance < cost){
              const shortage = cost - p.balance;
              if(!askLoan(p,'stock',shortage)){ // 當作小額投資貸
                // 不貸則放棄
                text = '資金不足，已放棄本次投資機會。';
                break;
              }
            }
            p.balance -= cost; p.expense += cost;
            p.pendingInvestment = { cost, expect, willResolve:true };
            pushLedger(p, {title:`投資提案（成本）`, tag:'💼', delta:-cost});
            text = `已投入 $${money(cost)}。將在你下一回合自動結算盈虧。`;
          }else{
            text = '你選擇不參與本次投資。';
          }
        } else {
          title=ev.title; text=ev.text; delta= ev.type==='income'? ev.amount : -ev.amount;
          if(ev.type==='income'){p.income+=ev.amount;p.balance+=ev.amount;}else{p.expense+=ev.amount;p.balance-=ev.amount;}
        }
        break;
      }
    }

    // 顯示卡片
    cardTitleEl.textContent=title;
    cardTextEl.textContent=text;
    if(delta!==0){
      cardAmountEl.textContent=(delta>=0?'收入 +':'支出 ')+money(Math.abs(delta));
      cardAmountEl.style.color=delta>=0?'var(--good)':'var(--bad)';
    }else{
      cardAmountEl.textContent='';
    }
    cardAvatarEl.src = p.img || svgAnimal('🙂','#ddd');
    characterNameEl.textContent=p.name;
    cardEl.style.display='block';

    // 記帳
    if(delta!==0){
      pushLedger(p, {title, tag:'🎴', delta:delta});
    }

    // 事件結束後檢查淨值勝利（如有設定）
    checkNetworthWin(p, currentIndex);
  }

  // === 流程 ===
  function startMarketTimer(){
    stopMarketTimer();
    marketTimer = setInterval(()=>{
      if(gameOver) return;
      MARKET.tickAll();
      renderStats();
      // 若正在股票面板上，順手更新持股表與現價
      if(stockActionsEl.style.display!=='none'){
        const p=players[currentIndex];
        const sym = (document.getElementById('stockSelect')||{}).value;
        if(sym){
          const halted = (MARKET.news[sym]?.halt||0)>0;
          document.getElementById('stockPrice').textContent = '$ ' + money(MARKET.price[sym]||0) + (halted?'（停牌）':'');
          renderHoldings(p, sym);
        }
      }
    }, 5000);
  }
  function stopMarketTimer(){
    if(marketTimer){ clearInterval(marketTimer); marketTimer=null; }
  }

  function startGame({reseed=false}={}){
    if(players.length<1){ alert('請至少加入 1 位玩家'); return; }
    roundMax = clamp(parseInt(roundLimitInput.value||'100',10),1,100);
    winTarget = Math.max(0, parseInt(winTargetInput.value||'0',10)); // 0 = 關閉淨值即勝
    const startMoney = Math.max(0, parseInt(startMoneyInput.value||'3000',10));

    roundNow=1; currentIndex=0; gameOver=false; allLedger.length=0;
    if(reseed){ TILES=buildTiles(PATH.length); MARKET.init(); }

    players = players.map(p=>{
      const bag={}; MARKET.list.forEach(s=>bag[s.symbol]={qty:0,avg:0});
      const np = { ...p, pos:0, income:0, expense:0, balance:startMoney, bankDeposit:0, ledger:[], stocks:bag, loans:[], skipTurns:0, pendingInvestment:null };
      np.ledger.push({ time:nowStr(), player:np.name, title:'初始資金', tag:'💵', delta:+startMoney, amount:startMoney, balance:startMoney, deposit:0 });
      return np;
    });

    gameEl.style.display='block';
    if(leftCol && setupEl){ leftCol.appendChild(setupEl); }

    startMarketTimer();
    renderStats();
  }

  function endGameByRounds(){
    const ranked = players.map((pp,idx)=>{
      return { pp, idx, pv: propertyValueForPlayer(idx), sv: stockValueOf(pp), loans: loanOutstanding(pp.loans||[]) };
    }).map(r=>({ ...r, nw: (r.pp.balance||0)+(r.pp.bankDeposit||0)+r.pv+r.sv-r.loans }))
      .sort((a,b)=>b.nw-a.nw);
    const top = ranked[0];
    alert(`⏱️ 達到 ${roundMax} 回合，${top.pp.name} 以資產淨值 ${money(top.nw)} 元獲勝！（現金 ${money(top.pp.balance)}｜存款 ${money(top.pp.bankDeposit)}｜地產 ${money(top.pv)}｜股票 ${money(top.sv)}｜貸款 ${money(top.loans)}）`);
    gameOver=true;
    stopMarketTimer();
  }

  function resolvePendingInvestment(p){
    if(p.pendingInvestment?.willResolve){
      // 結果在下一次輪到該玩家時觸發
      const { cost, expect } = p.pendingInvestment;
      // 產生實際結果：以期望為中心 ±50%
      const result = Math.round(expect + (Math.random()*2-1)*Math.abs(expect||200)*0.5);
      p.balance += result; (result>=0 ? p.income : p.expense) += Math.abs(result);
      pushLedger(p, {title:`投資結算`, tag:'💼', delta: result});
      p.pendingInvestment = null;
      cardEl.style.display='block';
      cardTitleEl.textContent='投資結算';
      cardTextEl.textContent = `本次投資結果：${result>=0? '獲利' : '虧損'} $${money(Math.abs(result))}`;
      cardAmountEl.textContent='';
    }
  }

  function advanceTurn(){
    cardEl.style.display='none'; if(!players.length || gameOver) return;
    currentIndex = (currentIndex + 1) % players.length;
    if(currentIndex===0){
      roundNow+=1;
      if(roundNow>roundMax){ endGameByRounds(); return; }
    }
    const p=players[currentIndex];

    // 若受傷住院，跳過一回合
    if(p.skipTurns && p.skipTurns>0){
      p.skipTurns -= 1;
      pushLedger(p, {title:'住院休息', tag:'🏥', delta:0});
      // 自動切下一位
      return advanceTurn();
    }

    // 投資事件結算（若上一圈參與）
    resolvePendingInvestment(p);

    renderStats(); resultEl.textContent='';
  }

  // 檢查是否繞一圈
  function didLap(prev, now){ return now < prev; }

  // 擲骰
  diceEl.addEventListener('click',()=>{
    if(gameOver){ return; }
    if(!players.length){ alert('請先加入玩家'); return; }

    MARKET.tickAll();

    const p=players[currentIndex];
    const prevPos = p.pos||0;
    const roll=Math.floor(Math.random()*6)+1; resultEl.textContent=`你擲出了：${roll}`;
    p.pos = ((p.pos||0)+roll) % PATH.length;

    // 繞圈事件
    if(didLap(prevPos, p.pos)){
      processLap(p);
    }

    renderBoard();
    applyTileEffect(p, roll);
  });

  okBtn.addEventListener('click', advanceTurn);
  nextBtn.addEventListener('click', advanceTurn);

  // 銀行面板打開時也允許直接點「知道了」關閉
  //（行為同上）

  quickNewBtn.addEventListener('click',()=>startGame({reseed:false}));
  reseedNewBtn.addEventListener('click',()=>startGame({reseed:true}));
  startBtn.addEventListener('click',()=>startGame({reseed:true}));

  // 啟動
  (function init(){
    // 建 avatar
    buildAvatars();
    // 初始棋盤與數據
    renderBoard();
    renderStats();
  })();

  // 基本測試（網址加 #test）
  function logTest(msg){ testOutput.style.display='block'; testOutput.textContent += msg + '\n'; }
  function runTests(){
    try{
      logTest('開始測試…');
      console.assert(PATH.length===64,'PATH=64');
      const uniq=new Set(PATH); console.assert(uniq.size===64,'PATH 不重複');
      const tmp=buildTiles(PATH.length); console.assert(tmp.length===64,'TILES=64');

      // 貸款攤還測試
      const pay = pmts(12000, 0.06, 12);
      console.assert(Math.abs(pay - 1032) < 50, 'pmts 約略正確');

      // 市場限制 ±10%
      const p0 = MARKET.price['LION'];
      MARKET.price['LION']=100;
      MARKET.news['LION']={halt:0,bias:0,biasTurns:0};
      MARKET.tickAll();
      const p1 = MARKET.price['LION'];
      console.assert(p1>=90 && p1<=110, '漲跌幅 ±10%');

      logTest('✓ OK');
    }catch(e){ logTest('❌ '+(e?.message||e)); }
  }
  if(location.hash==='#test'){ runTests(); }
});
</script>
</body>
</html>
